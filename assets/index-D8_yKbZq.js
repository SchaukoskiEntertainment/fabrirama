(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const h of o.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&s(h)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();var W=1e-6,$=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var n=0,t=arguments.length;t--;)n+=arguments[t]*arguments[t];return Math.sqrt(n)});function J(){var n=new $(16);return $!=Float32Array&&(n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=0,n[12]=0,n[13]=0,n[14]=0),n[0]=1,n[5]=1,n[10]=1,n[15]=1,n}function mt(n){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function xt(n,t){var e=t[0],s=t[1],i=t[2],o=t[3],h=t[4],a=t[5],c=t[6],u=t[7],d=t[8],m=t[9],f=t[10],y=t[11],E=t[12],p=t[13],I=t[14],A=t[15],R=e*a-s*h,T=e*c-i*h,C=e*u-o*h,v=s*c-i*a,k=s*u-o*a,U=i*u-o*c,q=d*p-m*E,z=d*I-f*E,Z=d*A-y*E,Q=m*I-f*p,tt=m*A-y*p,et=f*A-y*I,O=R*et-T*tt+C*Q+v*Z-k*z+U*q;return O?(O=1/O,n[0]=(a*et-c*tt+u*Q)*O,n[1]=(i*tt-s*et-o*Q)*O,n[2]=(p*U-I*k+A*v)*O,n[3]=(f*k-m*U-y*v)*O,n[4]=(c*Z-h*et-u*z)*O,n[5]=(e*et-i*Z+o*z)*O,n[6]=(I*C-E*U-A*T)*O,n[7]=(d*U-f*C+y*T)*O,n[8]=(h*tt-a*Z+u*q)*O,n[9]=(s*Z-e*tt-o*q)*O,n[10]=(E*k-p*C+A*R)*O,n[11]=(m*C-d*k-y*R)*O,n[12]=(a*z-h*Q-c*q)*O,n[13]=(e*Q-s*z+i*q)*O,n[14]=(p*T-E*v-I*R)*O,n[15]=(d*v-m*T+f*R)*O,n):null}function St(n,t,e){var s=t[0],i=t[1],o=t[2],h=t[3],a=t[4],c=t[5],u=t[6],d=t[7],m=t[8],f=t[9],y=t[10],E=t[11],p=t[12],I=t[13],A=t[14],R=t[15],T=e[0],C=e[1],v=e[2],k=e[3];return n[0]=T*s+C*a+v*m+k*p,n[1]=T*i+C*c+v*f+k*I,n[2]=T*o+C*u+v*y+k*A,n[3]=T*h+C*d+v*E+k*R,T=e[4],C=e[5],v=e[6],k=e[7],n[4]=T*s+C*a+v*m+k*p,n[5]=T*i+C*c+v*f+k*I,n[6]=T*o+C*u+v*y+k*A,n[7]=T*h+C*d+v*E+k*R,T=e[8],C=e[9],v=e[10],k=e[11],n[8]=T*s+C*a+v*m+k*p,n[9]=T*i+C*c+v*f+k*I,n[10]=T*o+C*u+v*y+k*A,n[11]=T*h+C*d+v*E+k*R,T=e[12],C=e[13],v=e[14],k=e[15],n[12]=T*s+C*a+v*m+k*p,n[13]=T*i+C*c+v*f+k*I,n[14]=T*o+C*u+v*y+k*A,n[15]=T*h+C*d+v*E+k*R,n}function V(n,t,e){var s=e[0],i=e[1],o=e[2],h,a,c,u,d,m,f,y,E,p,I,A;return t===n?(n[12]=t[0]*s+t[4]*i+t[8]*o+t[12],n[13]=t[1]*s+t[5]*i+t[9]*o+t[13],n[14]=t[2]*s+t[6]*i+t[10]*o+t[14],n[15]=t[3]*s+t[7]*i+t[11]*o+t[15]):(h=t[0],a=t[1],c=t[2],u=t[3],d=t[4],m=t[5],f=t[6],y=t[7],E=t[8],p=t[9],I=t[10],A=t[11],n[0]=h,n[1]=a,n[2]=c,n[3]=u,n[4]=d,n[5]=m,n[6]=f,n[7]=y,n[8]=E,n[9]=p,n[10]=I,n[11]=A,n[12]=h*s+d*i+E*o+t[12],n[13]=a*s+m*i+p*o+t[13],n[14]=c*s+f*i+I*o+t[14],n[15]=u*s+y*i+A*o+t[15]),n}function rt(n,t,e){var s=e[0],i=e[1],o=e[2];return n[0]=t[0]*s,n[1]=t[1]*s,n[2]=t[2]*s,n[3]=t[3]*s,n[4]=t[4]*i,n[5]=t[5]*i,n[6]=t[6]*i,n[7]=t[7]*i,n[8]=t[8]*o,n[9]=t[9]*o,n[10]=t[10]*o,n[11]=t[11]*o,n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15],n}function lt(n,t,e){var s=Math.sin(e),i=Math.cos(e),o=t[4],h=t[5],a=t[6],c=t[7],u=t[8],d=t[9],m=t[10],f=t[11];return t!==n&&(n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n[4]=o*i+u*s,n[5]=h*i+d*s,n[6]=a*i+m*s,n[7]=c*i+f*s,n[8]=u*i-o*s,n[9]=d*i-h*s,n[10]=m*i-a*s,n[11]=f*i-c*s,n}function it(n,t,e){var s=Math.sin(e),i=Math.cos(e),o=t[0],h=t[1],a=t[2],c=t[3],u=t[8],d=t[9],m=t[10],f=t[11];return t!==n&&(n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n[0]=o*i-u*s,n[1]=h*i-d*s,n[2]=a*i-m*s,n[3]=c*i-f*s,n[8]=o*s+u*i,n[9]=h*s+d*i,n[10]=a*s+m*i,n[11]=c*s+f*i,n}function pt(n,t,e){var s=Math.sin(e),i=Math.cos(e),o=t[0],h=t[1],a=t[2],c=t[3],u=t[4],d=t[5],m=t[6],f=t[7];return t!==n&&(n[8]=t[8],n[9]=t[9],n[10]=t[10],n[11]=t[11],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n[0]=o*i+u*s,n[1]=h*i+d*s,n[2]=a*i+m*s,n[3]=c*i+f*s,n[4]=u*i-o*s,n[5]=d*i-h*s,n[6]=m*i-a*s,n[7]=f*i-c*s,n}function _t(n,t,e,s,i){var o=1/Math.tan(t/2),h;return n[0]=o/e,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=o,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=-1,n[12]=0,n[13]=0,n[15]=0,i!=null&&i!==1/0?(h=1/(s-i),n[10]=(i+s)*h,n[14]=2*i*s*h):(n[10]=-1,n[14]=-2*s),n}var Ut=_t;function kt(n,t,e,s){var i,o,h,a,c,u,d,m,f,y,E=t[0],p=t[1],I=t[2],A=s[0],R=s[1],T=s[2],C=e[0],v=e[1],k=e[2];return Math.abs(E-C)<W&&Math.abs(p-v)<W&&Math.abs(I-k)<W?mt(n):(d=E-C,m=p-v,f=I-k,y=1/Math.hypot(d,m,f),d*=y,m*=y,f*=y,i=R*f-T*m,o=T*d-A*f,h=A*m-R*d,y=Math.hypot(i,o,h),y?(y=1/y,i*=y,o*=y,h*=y):(i=0,o=0,h=0),a=m*h-f*o,c=f*i-d*h,u=d*o-m*i,y=Math.hypot(a,c,u),y?(y=1/y,a*=y,c*=y,u*=y):(a=0,c=0,u=0),n[0]=i,n[1]=a,n[2]=d,n[3]=0,n[4]=o,n[5]=c,n[6]=m,n[7]=0,n[8]=h,n[9]=u,n[10]=f,n[11]=0,n[12]=-(i*E+o*p+h*I),n[13]=-(a*E+c*p+u*I),n[14]=-(d*E+m*p+f*I),n[15]=1,n)}function F(){var n=new $(3);return $!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n}function N(n){var t=new $(3);return t[0]=n[0],t[1]=n[1],t[2]=n[2],t}function Ht(n){var t=n[0],e=n[1],s=n[2];return Math.hypot(t,e,s)}function K(n,t,e){var s=new $(3);return s[0]=n,s[1]=t,s[2]=e,s}function Et(n,t){return n[0]=t[0],n[1]=t[1],n[2]=t[2],n}function Bt(n,t,e){return n[0]=t[0]+e[0],n[1]=t[1]+e[1],n[2]=t[2]+e[2],n}function Gt(n,t,e){return n[0]=t[0]-e[0],n[1]=t[1]-e[1],n[2]=t[2]-e[2],n}function st(n,t,e,s){return n[0]=t[0]+e[0]*s,n[1]=t[1]+e[1]*s,n[2]=t[2]+e[2]*s,n}function nt(n,t){var e=t[0],s=t[1],i=t[2],o=e*e+s*s+i*i;return o>0&&(o=1/Math.sqrt(o)),n[0]=t[0]*o,n[1]=t[1]*o,n[2]=t[2]*o,n}function Vt(n,t,e){var s=t[0],i=t[1],o=t[2],h=e[0],a=e[1],c=e[2];return n[0]=i*c-o*a,n[1]=o*h-s*c,n[2]=s*a-i*h,n}function Kt(n,t,e,s){var i=t[0],o=t[1],h=t[2];return n[0]=i+s*(e[0]-i),n[1]=o+s*(e[1]-o),n[2]=h+s*(e[2]-h),n}function Yt(n,t){var e=n[0],s=n[1],i=n[2],o=t[0],h=t[1],a=t[2];return Math.abs(e-o)<=W*Math.max(1,Math.abs(e),Math.abs(o))&&Math.abs(s-h)<=W*Math.max(1,Math.abs(s),Math.abs(h))&&Math.abs(i-a)<=W*Math.max(1,Math.abs(i),Math.abs(a))}var Lt=Gt;(function(){var n=F();return function(t,e,s,i,o,h){var a,c;for(e||(e=3),s||(s=0),i?c=Math.min(i*e+s,t.length):c=t.length,a=s;a<c;a+=e)n[0]=t[a],n[1]=t[a+1],n[2]=t[a+2],o(n,n,h),t[a]=n[0],t[a+1]=n[1],t[a+2]=n[2];return t}})();const Xt=!1,P=document.getElementById("glCanvas"),Nt=P.getContext("webgl",{alpha:Xt});if(!Nt)throw new Error("Gl is null!");const r=Nt;class ht{constructor(t,e){this.nameId=t,this.mesh=e,this.model=J(),this.position=F(),this.scale=[1,1,1],this.rotation=K(0,0,0),this.visible=!0,this.handItem=!1,this.rotate90=!0}getRotate90(){return this.rotate90}getHandItem(){return this.handItem}getModel(){return this.model}update(t,e){}getNameId(){return this.nameId}setVisible(t){this.visible=t}getVisible(){return this.visible}}class Wt{constructor(){this.texture=null,this.isLoaded=!1,this.image=null}loadFromUrl(t){return new Promise((e,s)=>{const i=new Image;i.crossOrigin="anonymous",i.onload=()=>{e()},i.onerror=()=>s(new Error("Failed to load texture image")),i.src=t,this.image=i})}createTexture(t){this.texture=r.createTexture(),r.bindTexture(r.TEXTURE_2D,this.texture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,t),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.bindTexture(r.TEXTURE_2D,null),this.isLoaded=!0}bind(t=0){!this.isLoaded||!this.texture||(r.activeTexture(r.TEXTURE0+t),r.bindTexture(r.TEXTURE_2D,this.texture))}unbind(){r.bindTexture(r.TEXTURE_2D,null)}isTextureLoaded(){return this.isLoaded}getWebGLTexture(){return this.texture}getImage(){return this.image}}let ut=null;function $t(n){return ut=new Wt,ut.loadFromUrl(n)}function dt(){if(!ut)throw new Error("Blocks texture has not been loaded yet.");return ut}class Ot{constructor(t,e=16,s=3){this.texture=t,this.tileSize=e,this.padding=s;const i=t.getImage();if(i!=null)this.paddedCanvas=this.generatePaddedAtlas(i,this.tileSize,this.padding),this.atlasSize=this.paddedCanvas.width,this.imageData=this.ctx.getImageData(0,0,this.atlasSize,this.atlasSize),t.createTexture(this.paddedCanvas);else throw new Error("Texture image not loaded")}generatePaddedAtlas(t,e=16,s=2){const i=t.width/e,o=e+s*2,h=i*o,a=document.createElement("canvas");a.width=h,a.height=h,this.ctx=a.getContext("2d"),this.ctx.imageSmoothingEnabled=!1;for(let c=0;c<i*i;c++){const u=c%i,d=Math.floor(c/i),m=u*e,f=d*e,y=u*o+s,E=d*o+s;this.ctx.drawImage(t,m,f,e,e,y,E,e,e);for(let p=0;p<e;p++)this.ctx.drawImage(t,m+p,f,1,1,y+p,E-s,1,s),this.ctx.drawImage(t,m+p,f+e-1,1,1,y+p,E+e,1,s);for(let p=0;p<e;p++)this.ctx.drawImage(t,m,f+p,1,1,y-s,E+p,s,1),this.ctx.drawImage(t,m+e-1,f+p,1,1,y+e,E+p,s,1);this.ctx.drawImage(t,m,f,1,1,y-s,E-s,s,s),this.ctx.drawImage(t,m+e-1,f,1,1,y+e,E-s,s,s),this.ctx.drawImage(t,m,f+e-1,1,1,y-s,E+e,s,s),this.ctx.drawImage(t,m+e-1,f+e-1,1,1,y+e,E+e,s,s)}return a}getPixelColor(t,e,s){const i=this.tileSize+this.padding*2,o=Math.floor(this.atlasSize/i),h=s%o,a=Math.floor(s/o);t=h*i+this.padding+t,e=a*i+this.padding+e;const c=(e*this.atlasSize+t)*4,u=this.imageData.data;return{r:u[c],g:u[c+1],b:u[c+2],a:u[c+3]}}getUVs(t){const e=this.tileSize+this.padding*2,s=Math.floor(this.atlasSize/e),i=t%s,o=Math.floor(t/s),h=this.atlasSize,a=this.atlasSize,c=(i*e+this.padding)/h,u=(o*e+this.padding)/a,d=c+this.tileSize/h,m=u+this.tileSize/a;return[c,u,d,u,c,m,d,m]}getTexture(){return this.texture}}function Jt(n){const t=g[n];return jt[t]}var G=(n=>(n[n.TOP=0]="TOP",n[n.BOTTOM=1]="BOTTOM",n[n.LEFT=2]="LEFT",n[n.RIGHT=3]="RIGHT",n[n.FRONT=4]="FRONT",n[n.BACK=5]="BACK",n))(G||{}),g=(n=>(n[n.AIR=0]="AIR",n[n.GRASS=1]="GRASS",n[n.STONE=2]="STONE",n[n.LEAVES=3]="LEAVES",n[n.OAKWOOD=4]="OAKWOOD",n[n.BRICKWOOD=5]="BRICKWOOD",n[n.DIRT=6]="DIRT",n[n.BREAK1=7]="BREAK1",n[n.BREAK2=8]="BREAK2",n[n.BREAK3=9]="BREAK3",n[n.BREAK4=10]="BREAK4",n[n.BREAK5=11]="BREAK5",n[n.BREAK6=12]="BREAK6",n[n.PORTAL1=13]="PORTAL1",n[n.PORTAL2=14]="PORTAL2",n[n.REDCUBE=15]="REDCUBE",n[n.LABBLOCK=16]="LABBLOCK",n[n.LABBLOCK2=17]="LABBLOCK2",n))(g||{});const vt=[.9,.5,.5,.7,.8,.6],jt={AIR:{TOP:0,BOTTOM:0,LEFT:0,RIGHT:0,FRONT:0,BACK:0},GRASS:{TOP:2,BOTTOM:0,LEFT:1,RIGHT:1,FRONT:1,BACK:1},STONE:{TOP:3,BOTTOM:3,LEFT:3,RIGHT:3,FRONT:3,BACK:3},LEAVES:{TOP:6,BOTTOM:6,LEFT:6,RIGHT:6,FRONT:6,BACK:6},OAKWOOD:{TOP:5,BOTTOM:5,LEFT:4,RIGHT:4,FRONT:4,BACK:4},BRICKWOOD:{TOP:20,BOTTOM:20,LEFT:20,RIGHT:20,FRONT:20,BACK:20},DIRT:{TOP:0,BOTTOM:0,LEFT:0,RIGHT:0,FRONT:0,BACK:0},BREAK1:{TOP:9,BOTTOM:9,LEFT:9,RIGHT:9,FRONT:9,BACK:9},BREAK2:{TOP:10,BOTTOM:10,LEFT:10,RIGHT:10,FRONT:10,BACK:10},BREAK3:{TOP:11,BOTTOM:11,LEFT:11,RIGHT:11,FRONT:11,BACK:11},BREAK4:{TOP:12,BOTTOM:12,LEFT:12,RIGHT:12,FRONT:12,BACK:12},BREAK5:{TOP:13,BOTTOM:13,LEFT:13,RIGHT:13,FRONT:13,BACK:13},BREAK6:{TOP:14,BOTTOM:14,LEFT:14,RIGHT:14,FRONT:14,BACK:14},PORTAL1:{TOP:21,BOTTOM:21,LEFT:21,RIGHT:21,FRONT:21,BACK:21},PORTAL2:{TOP:22,BOTTOM:22,LEFT:22,RIGHT:22,FRONT:22,BACK:22},REDCUBE:{TOP:15,BOTTOM:15,LEFT:15,RIGHT:15,FRONT:15,BACK:15},LABBLOCK:{TOP:33,BOTTOM:33,LEFT:33,RIGHT:33,FRONT:33,BACK:33},LABBLOCK2:{TOP:34,BOTTOM:34,LEFT:34,RIGHT:34,FRONT:34,BACK:34}},H=[-.5,.5,.5,.5,.5,.5,-.5,.5,-.5,.5,.5,-.5,-.5,-.5,-.5,.5,-.5,-.5,-.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,.5,.5,.5,-.5,-.5,-.5,.5,.5,-.5,.5,-.5,.5,.5,.5,.5,.5,.5,-.5,-.5,-.5,-.5,-.5,.5,.5,-.5,-.5,.5,-.5];class Tt{constructor(t,e,s=!1){this.uvBuffer=null,this.brightnessBuffer=null,this.emptyVertices=[],this.uvs=[],this.brightness=[],this.currentIndice=0,this.textureAtlas=new Ot(dt(),16),this.drawLinesInsteadTriangles=!1,this.drawLinesInsteadTriangles=s,this.vertexBuffer=null,this.indexBuffer=null,this.vertices=[],this.indices=[],this.indexVertices=t,this.shader=e}updateBuffers(){r.bindBuffer(r.ARRAY_BUFFER,this.vertexBuffer),r.bufferData(r.ARRAY_BUFFER,new Float32Array(this.vertices),r.DYNAMIC_DRAW),r.bindBuffer(r.ARRAY_BUFFER,this.uvBuffer),r.bufferData(r.ARRAY_BUFFER,new Float32Array(this.uvs),r.DYNAMIC_DRAW),r.bindBuffer(r.ARRAY_BUFFER,this.brightnessBuffer),r.bufferData(r.ARRAY_BUFFER,new Float32Array(this.brightness),r.DYNAMIC_DRAW),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,this.indexBuffer),r.bufferData(r.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),r.DYNAMIC_DRAW)}getBrightnessBuffer(){return this.brightnessBuffer}getVertexBuffer(){return this.vertexBuffer}getUvBuffer(){return this.uvBuffer}set chunk(t){this._chunk=t}generateMeshData(t){this._chunk=t;for(let e=0;e<this._chunk.getChunkWidth();e++)for(let s=0;s<this._chunk.getChunkHeight();s++)for(let i=0;i<this._chunk.getChunkDepth();i++)this._chunk.getBlocks()[e][s][i]!=0&&this.createCube(e,s,i);this.init()}createCube(t,e,s){!this.hasBlock(t,e+1,s)&&this.indexVertices[t][e][s][0]==null&&this.createFace(0,t,e,s),!this.hasBlock(t,e-1,s)&&this.indexVertices[t][e][s][1]==null&&this.createFace(1,t,e,s),!this.hasBlock(t-1,e,s)&&this.indexVertices[t][e][s][2]==null&&this.createFace(2,t,e,s),!this.hasBlock(t+1,e,s)&&this.indexVertices[t][e][s][3]==null&&this.createFace(3,t,e,s),!this.hasBlock(t,e,s+1)&&this.indexVertices[t][e][s][4]==null&&this.createFace(4,t,e,s),!this.hasBlock(t,e,s-1)&&this.indexVertices[t][e][s][5]==null&&this.createFace(5,t,e,s)}hasBlock(t,e,s){if(this._chunk.getNameId()=="HandItemCube")return 0;if(t>this._chunk.getChunkWidth()-1){const i=this._chunk.getNameId().match(/Chunk\[(-?\d+),(-?\d+)\]/);if(i){const o=parseInt(i[1]),h=parseInt(i[2]),a=l.getEntityByName(`Chunk[${o+1},${h}]`);if(a&&a.getBlocks()[0][e]&&a.getBlocks()[0][e][s]!=0)return a.getBlocks()[0][e][s]}return 0}else if(t<0){const i=this._chunk.getNameId().match(/Chunk\[(-?\d+),(-?\d+)\]/);if(i){const o=parseInt(i[1]),h=parseInt(i[2]),a=l.getEntityByName(`Chunk[${o-1},${h}]`);if(a&&a.getBlocks()[a.getChunkWidth()-1][e]&&a.getBlocks()[a.getChunkWidth()-1][e][s]!=0)return a.getBlocks()[a.getChunkWidth()-1][e][s]}return 0}else if(s>this._chunk.getChunkDepth()-1){const i=this._chunk.getNameId().match(/Chunk\[(-?\d+),(-?\d+)\]/);if(i){const o=parseInt(i[1]),h=parseInt(i[2]),a=l.getEntityByName(`Chunk[${o},${h+1}]`);if(a&&a.getBlocks()[t][e]&&a.getBlocks()[t][e][0]!=0)return a.getBlocks()[t][e][0]}return 0}else if(s<0){const i=this._chunk.getNameId().match(/Chunk\[(-?\d+),(-?\d+)\]/);if(i){const o=parseInt(i[1]),h=parseInt(i[2]),a=l.getEntityByName(`Chunk[${o},${h-1}]`);if(a&&a.getBlocks()[t][e]&&a.getBlocks()[t][e][a.getChunkDepth()-1]!=0)return a.getBlocks()[t][e][a.getChunkDepth()-1]}return 0}return e<0||e>this._chunk.getChunkHeight()-1?0:this._chunk.getBlocks()[t][e][s]}getShader(){return this.shader}removeBlockMeshAndAdd(t){t=[Math.floor(t[0]+.5),Math.floor(t[1]+.5),Math.floor(t[2]+.5)];let[e,s,i]=t;if(e=(e%16+16)%16,i=(i%16+16)%16,this.hasBlock(e,s,i)){for(let o=0;o<6;o++){const h=this.indexVertices[e][s][i][o];if(h!=null){this.emptyVertices.push(h);let a=this.getVertices();for(let c=0;c<12;c++)a[h/4+c]=0;r.bindBuffer(r.ARRAY_BUFFER,this.vertexBuffer),r.bufferSubData(r.ARRAY_BUFFER,h,new Float32Array([0,0,0,0,0,0,0,0,0,0,0,0])),this.indexVertices[e][s][i][o]=null}}this.addMeshBlock([e,s,i])}}addMeshBlock(t){t=[Math.floor(t[0]+.5),Math.floor(t[1]+.5),Math.floor(t[2]+.5)];const[e,s,i]=t;if(this.hasBlock(e,s,i))if(e>this._chunk.getChunkWidth()-1){const o=this._chunk.getNameId().match(/Chunk\[(-?\d+),(-?\d+)\]/);if(o){const h=parseInt(o[1]),a=parseInt(o[2]),c=l.getEntityByName(`Chunk[${h+1},${a}]`);c&&c.getBlocks()[0][s][i]!=0&&(c.mesh.createCube(0,s,i),c.updateChunk())}}else if(e<0){const o=this._chunk.getNameId().match(/Chunk\[(-?\d+),(-?\d+)\]/);if(o){const h=parseInt(o[1]),a=parseInt(o[2]),c=l.getEntityByName(`Chunk[${h-1},${a}]`);c&&c.getBlocks()[this._chunk.getChunkWidth()-1][s][i]!=0&&(c.mesh.createCube(this._chunk.getChunkWidth()-1,s,i),c.updateChunk())}}else if(i>this._chunk.getChunkDepth()-1){const o=this._chunk.getNameId().match(/Chunk\[(-?\d+),(-?\d+)\]/);if(o){const h=parseInt(o[1]),a=parseInt(o[2]),c=l.getEntityByName(`Chunk[${h},${a+1}]`);c&&c.getBlocks()[e][s][0]!=0&&(c.mesh.createCube(e,s,0),c.updateChunk())}}else if(i<0){const o=this._chunk.getNameId().match(/Chunk\[(-?\d+),(-?\d+)\]/);if(o){const h=parseInt(o[1]),a=parseInt(o[2]),c=l.getEntityByName(`Chunk[${h},${a-1}]`);c&&c.getBlocks()[e][s][this._chunk.getChunkDepth()-1]!=0&&(c.mesh.createCube(e,s,this._chunk.getChunkDepth()-1),c.updateChunk())}}else this.createCube(e,s,i)}addBlock(t,e,s=!1){t=[Math.floor(t[0]+.5),Math.floor(t[1]+.5),Math.floor(t[2]+.5)];let[i,o,h]=t;if(i=(i%16+16)%16,h=(h%16+16)%16,this.hasBlock(i,o,h)){if(s){this.removeBlock(t),e!=0&&this.addBlock(t,e);return}}else{const a=l.getEntityByName("Player");if(e!=null?this._chunk.getBlocks()[i][o][h]=e:this._chunk.getBlocks()[i][o][h]=a.toolbar.currentItem.value,i==this._chunk.getChunkWidth()-1){const c=this._chunk.getNameId().match(/\[(-?\d+),(-?\d+)\]/);if(c){const u=parseInt(c[1]),d=parseInt(c[2]),m=l.getEntityByName(`Chunk[${u+1},${d}]`);m&&m.getBlocks()[0][o]&&m.getBlocks()[0][o][h]!=0&&m.mesh.removeBlockMeshAndAdd([i+1,o,h])}}else this.removeBlockMeshAndAdd([i+1,o,h]);if(i==0){const c=this._chunk.getNameId().match(/\[(-?\d+),(-?\d+)\]/);if(c){const u=parseInt(c[1]),d=parseInt(c[2]),m=l.getEntityByName(`Chunk[${u-1},${d}]`);m&&m.getBlocks()[m.getChunkWidth()-1][o]&&m.getBlocks()[m.getChunkWidth()-1][o][h]!=0&&m.mesh.removeBlockMeshAndAdd([i-1,o,h])}}else this.removeBlockMeshAndAdd([i-1,o,h]);if(h==this._chunk.getChunkDepth()-1){const c=this._chunk.getNameId().match(/\[(-?\d+),(-?\d+)\]/);if(c){const u=parseInt(c[1]),d=parseInt(c[2]),m=l.getEntityByName(`Chunk[${u},${d+1}]`);m&&m.getBlocks()[i][o]&&m.getBlocks()[i][o][0]!=0&&m.mesh.removeBlockMeshAndAdd([i,o,h+1])}}else this.removeBlockMeshAndAdd([i,o,h+1]);if(h==0){const c=this._chunk.getNameId().match(/\[(-?\d+),(-?\d+)\]/);if(c){const u=parseInt(c[1]),d=parseInt(c[2]),m=l.getEntityByName(`Chunk[${u},${d-1}]`);m&&m.getBlocks()[i][o]&&m.getBlocks()[i][o][m.getChunkDepth()-1]!=0&&m.mesh.removeBlockMeshAndAdd([i,o,h-1])}}else this.removeBlockMeshAndAdd([i,o,h-1]);this.removeBlockMeshAndAdd([i,o+1,h]),this.removeBlockMeshAndAdd([i,o-1,h]),e!=0&&this.createCube(i,o,h)}this._chunk.updateChunk()}removeBlock(t){t=[Math.floor(t[0]+.5),Math.floor(t[1]+.5),Math.floor(t[2]+.5)];let[e,s,i]=t;e=(e%16+16)%16,i=(i%16+16)%16,this._chunk.getBlocks()[e][s][i]=0;for(let o=0;o<6;o++){const h=this.indexVertices[e][s][i][o];if(h!=null){this.emptyVertices.push(h);let a=this.getVertices();for(let c=0;c<12;c++)a[h/4+c]=0;r.bindBuffer(r.ARRAY_BUFFER,this.vertexBuffer),r.bufferSubData(r.ARRAY_BUFFER,h,new Float32Array([0,0,0,0,0,0,0,0,0,0,0,0])),this.indexVertices[e][s][i][o]=null}}this.addMeshBlock([e+1,s,i]),this.addMeshBlock([e-1,s,i]),this.addMeshBlock([e,s+1,i]),this.addMeshBlock([e,s-1,i]),this.addMeshBlock([e,s,i+1]),this.addMeshBlock([e,s,i-1]),this._chunk.updateChunk()}createFace(t,e,s,i){const o=this._chunk.getBlocks()[e][s][i],h=G[t],a=Jt(o)[h],c=4;if(this.emptyVertices.length>0){const u=this.emptyVertices.pop();if(u!=null){const d=[];let m=this.getVertices();for(let k=0;k<4;k++)d.push(H[t*12+k*3]+e),d.push(H[t*12+1+k*3]+s),d.push(H[t*12+2+k*3]+i),m[u/4+k*3]=H[t*12+k*3]+e,m[u/4+k*3+1]=H[t*12+1+k*3]+s,m[u/4+k*3+2]=H[t*12+2+k*3]+i;this.indexVertices[e][s][i][t]=u,r.bindBuffer(r.ARRAY_BUFFER,this.getVertexBuffer()),r.bufferSubData(r.ARRAY_BUFFER,u,new Float32Array(d));const f=u/c/3*2*c,y=[];let E=this.getUVs();const p=this.textureAtlas.getUVs(a);y.push(p[0],p[5]),y.push(p[2],p[7]),y.push(p[4],p[1]),y.push(p[6],p[3]);const I=f/c;for(let k=0;k<8;k++)E[I+k]=y[k];r.bindBuffer(r.ARRAY_BUFFER,this.getUvBuffer()),r.bufferSubData(r.ARRAY_BUFFER,f,new Float32Array(y));const A=u/c/3*1*c,R=vt[t],T=[];let C=this.getBrightness();T.push(R),T.push(R),T.push(R),T.push(R);const v=A/c;for(let k=0;k<4;k++)C[v+k]=T[k];r.bindBuffer(r.ARRAY_BUFFER,this.getBrightnessBuffer()),r.bufferSubData(r.ARRAY_BUFFER,A,new Float32Array(T))}}else{this.indexVertices[e][s][i][t]=this.vertices.length*c;for(let m=0;m<4;m++)this.vertices.push(H[t*12+m*3]+e),this.vertices.push(H[t*12+1+m*3]+s),this.vertices.push(H[t*12+2+m*3]+i);this.indices.push(this.currentIndice+0),this.indices.push(this.currentIndice+1),this.indices.push(this.currentIndice+2),this.indices.push(this.currentIndice+1),this.indices.push(this.currentIndice+3),this.indices.push(this.currentIndice+2);const u=this.textureAtlas.getUVs(a);this.uvs.push(u[0],u[5]),this.uvs.push(u[2],u[7]),this.uvs.push(u[4],u[1]),this.uvs.push(u[6],u[3]);const d=vt[t];this.brightness.push(d),this.brightness.push(d),this.brightness.push(d),this.brightness.push(d),this.currentIndice+=4}}init(){this.vertices.length&&(this.vertexBuffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.vertexBuffer),r.bufferData(r.ARRAY_BUFFER,new Float32Array(this.vertices),r.STATIC_DRAW),this.uvBuffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.uvBuffer),r.bufferData(r.ARRAY_BUFFER,new Float32Array(this.uvs),r.STATIC_DRAW),this.brightnessBuffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.brightnessBuffer),r.bufferData(r.ARRAY_BUFFER,new Float32Array(this.brightness),r.STATIC_DRAW),this.indexBuffer=r.createBuffer(),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,this.indexBuffer),r.bufferData(r.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),r.STATIC_DRAW))}getVertices(){return this.vertices}setVertices(t){this.vertices=t}getIndices(){return this.indices}getUVs(){return this.uvs}getBrightness(){return this.brightness}render(t){if(!this.vertexBuffer||!t.getVisible())return;this.shader.use();const e=t.getModel(),s=this.shader.getAttribLocation("aPosition"),i=this.shader.getUniformLocation("uModel");if(mt(e),V(e,e,t.position),t.getHandItem()){const u=l.getEntityByName("HandItemTool").getSwayOffset();it(e,e,u[0]),t.getRotate90()?(lt(e,e,90*(Math.PI/180)),pt(e,e,50*(Math.PI/180))):it(e,e,-50*(Math.PI/180)),rt(e,e,t.scale);let d=J();xt(d,l.getEntityByName("Player").getCamera().getViewMatrix()),St(e,d,e)}else rt(e,e,t.scale);r.uniformMatrix4fv(i,!1,e),r.bindBuffer(r.ARRAY_BUFFER,this.vertexBuffer),r.enableVertexAttribArray(s),r.vertexAttribPointer(s,this.shader.isPositionVec3?3:2,r.FLOAT,!1,0,0),dt().bind(0);const h=this.shader.getAttribLocation("aTexCoord");r.bindBuffer(r.ARRAY_BUFFER,this.uvBuffer),r.enableVertexAttribArray(h),r.vertexAttribPointer(h,2,r.FLOAT,!1,0,0);const a=this.shader.getAttribLocation("aBrightness");r.bindBuffer(r.ARRAY_BUFFER,this.brightnessBuffer),r.enableVertexAttribArray(a),r.vertexAttribPointer(a,1,r.FLOAT,!1,0,0),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,this.indexBuffer),this.drawLinesInsteadTriangles?r.drawElements(r.LINES,this.indices.length,r.UNSIGNED_SHORT,0):r.drawElements(r.TRIANGLES,this.indices.length,r.UNSIGNED_SHORT,0)}}const yt=[-.5,.5,.5,.5,.5,.5,-.5,.5,-.5,.5,.5,-.5,-.5,-.5,-.5,.5,-.5,-.5,-.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,.5,.5,.5,-.5,-.5,-.5,.5,.5,-.5,.5,-.5,.5,.5,.5,.5,.5,.5,-.5,-.5,-.5,-.5,-.5,.5,.5,-.5,-.5,.5,-.5];class bt{constructor(t,e,s,i=16){this.itemIndexInTextureAtlas=s,this.tileSize=i,this.colors=[],this.brightness=[],this.currentIndice=0,this.textureAtlas=new Ot(dt(),16),this.colorBuffer=null,this.brightnessBuffer=null,this.drawLinesInsteadTriangles=!1,this.vertexBuffer=null,this.indexBuffer=null,this.vertices=[],this.indices=[],this.indexVertices=t,this.shader=e}generateMeshData(){for(let t=0;t<this.tileSize;t++)for(let e=0;e<1;e++)for(let s=0;s<this.tileSize;s++)this.textureAtlas.getPixelColor(t,s,this.itemIndexInTextureAtlas).a>0&&this.createCube(t,e,s);this.init()}updateBuffers(){r.bindBuffer(r.ARRAY_BUFFER,this.vertexBuffer),r.bufferData(r.ARRAY_BUFFER,new Float32Array(this.vertices),r.DYNAMIC_DRAW),r.bindBuffer(r.ARRAY_BUFFER,this.colorBuffer),r.bufferData(r.ARRAY_BUFFER,new Float32Array(this.colors),r.DYNAMIC_DRAW),r.bindBuffer(r.ARRAY_BUFFER,this.brightnessBuffer),r.bufferData(r.ARRAY_BUFFER,new Float32Array(this.brightness),r.DYNAMIC_DRAW),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,this.indexBuffer),r.bufferData(r.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),r.DYNAMIC_DRAW)}getShader(){return this.shader}render(t){if(!this.vertexBuffer||!t.getVisible())return;this.shader.use();const e=t.getModel(),s=this.shader.getAttribLocation("aPosition"),i=this.shader.getUniformLocation("uModel");if(mt(e),V(e,e,t.position),t.getHandItem()){const c=l.getEntityByName("HandItemTool"),u=c.getSwayOffset();if(it(e,e,u[0]),c.isBreaking()){const m=l.getEntityByName("Player"),f=c.getBreakingPhase();if(m.toolbar.currentItem.value==L.SHOVEL||m.toolbar.currentItem.value==L.GOLDENSHOVEL)V(e,e,[0,-.05,-.05*f]),lt(e,e,-90*(Math.PI/180));else if(m.toolbar.currentItem.value==L.PICKAXE||m.toolbar.currentItem.value==L.GOLDENPICKAXE){const E=.02*Math.abs(f);it(e,e,50),V(e,e,[0,-.01-E,.1*f])}}t.getRotate90()?(lt(e,e,90*(Math.PI/180)),pt(e,e,50*(Math.PI/180))):it(e,e,-50*(Math.PI/180)),rt(e,e,t.scale);let d=J();xt(d,l.getEntityByName("Player").getCamera().getViewMatrix()),St(e,d,e)}else{rt(e,e,t.scale),t.getRotate90()&&lt(e,e,90*(Math.PI/180)),V(e,e,[8,0,0]);const m=performance.now()/1e3*1.5;pt(e,e,m),V(e,e,[-8,0,0])}r.uniformMatrix4fv(i,!1,e),r.bindBuffer(r.ARRAY_BUFFER,this.vertexBuffer),r.enableVertexAttribArray(s),r.vertexAttribPointer(s,this.shader.isPositionVec3?3:2,r.FLOAT,!1,0,0),dt().bind(0);const h=this.shader.getAttribLocation("aColor");r.bindBuffer(r.ARRAY_BUFFER,this.colorBuffer),r.enableVertexAttribArray(h),r.vertexAttribPointer(h,3,r.FLOAT,!1,0,0);const a=this.shader.getAttribLocation("aBrightness");r.bindBuffer(r.ARRAY_BUFFER,this.brightnessBuffer),r.enableVertexAttribArray(a),r.vertexAttribPointer(a,1,r.FLOAT,!1,0,0),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,this.indexBuffer),this.drawLinesInsteadTriangles?r.drawElements(r.LINES,this.indices.length,r.UNSIGNED_SHORT,0):r.drawElements(r.TRIANGLES,this.indices.length,r.UNSIGNED_SHORT,0)}init(){this.vertices.length&&(this.vertexBuffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.vertexBuffer),r.bufferData(r.ARRAY_BUFFER,new Float32Array(this.vertices),r.STATIC_DRAW),this.colorBuffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.colorBuffer),r.bufferData(r.ARRAY_BUFFER,new Float32Array(this.colors),r.STATIC_DRAW),this.brightnessBuffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.brightnessBuffer),r.bufferData(r.ARRAY_BUFFER,new Float32Array(this.brightness),r.STATIC_DRAW),this.indexBuffer=r.createBuffer(),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,this.indexBuffer),r.bufferData(r.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),r.STATIC_DRAW))}createCube(t,e,s){(this.textureAtlas.getPixelColor(t,s+1,this.itemIndexInTextureAtlas).a==0||s==this.tileSize-1)&&this.createFace(G.FRONT,t,e,s),(this.textureAtlas.getPixelColor(t,s-1,this.itemIndexInTextureAtlas).a==0||s==0)&&this.createFace(G.BACK,t,e,s),this.hasBlock(t,e+1,s)||this.createFace(G.TOP,t,e,s),this.hasBlock(t,e-1,s)||this.createFace(G.BOTTOM,t,e,s),this.textureAtlas.getPixelColor(t-1,s,this.itemIndexInTextureAtlas).a==0&&this.createFace(G.LEFT,t,e,s),(t==this.tileSize-1||this.textureAtlas.getPixelColor(t+1,s,this.itemIndexInTextureAtlas).a==0)&&this.createFace(G.RIGHT,t,e,s)}hasBlock(t,e,s){return t<0||t>=this.tileSize||e<0||e>=1||s<0||s>=this.tileSize?0:this.textureAtlas.getPixelColor(t,s,this.itemIndexInTextureAtlas).a!=0}createFace(t,e,s,i){const o=this.textureAtlas.getPixelColor(e,i,this.itemIndexInTextureAtlas);for(let a=0;a<4;a++)this.vertices.push(yt[t*12+a*3]+e),this.vertices.push(yt[t*12+1+a*3]+s),this.vertices.push(yt[t*12+2+a*3]+i);this.indices.push(this.currentIndice+0),this.indices.push(this.currentIndice+1),this.indices.push(this.currentIndice+2),this.indices.push(this.currentIndice+1),this.indices.push(this.currentIndice+3),this.indices.push(this.currentIndice+2),this.colors.push(o.r/255,o.g/255,o.b/255),this.colors.push(o.r/255,o.g/255,o.b/255),this.colors.push(o.r/255,o.g/255,o.b/255),this.colors.push(o.r/255,o.g/255,o.b/255);const h=vt[t];this.brightness.push(h),this.brightness.push(h),this.brightness.push(h),this.brightness.push(h),this.currentIndice+=4}getVertices(){return this.vertices}getIndices(){return this.indices}getColors(){return this.colors}getBrightness(){return this.brightness}}class ft{constructor(t,e){this.isPositionVec3=!1,this.hasTexCoord=!1,this.hasColor=!1,this.hasBrightness=!1;const s=this.compileShader(r.VERTEX_SHADER,t),i=this.compileShader(r.FRAGMENT_SHADER,e);if(this.program=r.createProgram(),r.attachShader(this.program,s),r.attachShader(this.program,i),r.linkProgram(this.program),!r.getProgramParameter(this.program,r.LINK_STATUS)){const o=r.getProgramInfoLog(this.program);throw new Error(`Shader program linking failed:
`+o)}this.detectPositionAttributeType(t),this.detectTexCoordAttribute(t),this.detectColorsAttribute(t),this.detectBrightnessAttribute(t)}detectPositionAttributeType(t){const e=/attribute\s+vec(\d)\s+aPosition/,s=t.match(e);s&&(this.isPositionVec3=s[1]==="3")}detectTexCoordAttribute(t){const e=/attribute\s+vec2\s+aTexCoord/;this.hasTexCoord=e.test(t)}detectColorsAttribute(t){const e=/attribute\s+vec3\s+aColor/;this.hasColor=e.test(t)}detectBrightnessAttribute(t){const e=/attribute\s+float\s+aBrightness/;this.hasBrightness=e.test(t)}compileShader(t,e){const s=r.createShader(t);if(r.shaderSource(s,e),r.compileShader(s),!r.getShaderParameter(s,r.COMPILE_STATUS)){const i=r.getShaderInfoLog(s);throw new Error(`Shader compile error (${t===r.VERTEX_SHADER?"VERTEX":"FRAGMENT"}):
${i}`)}return s}use(){r.useProgram(this.program)}getAttribLocation(t){return r.getAttribLocation(this.program,t)}getUniformLocation(t){const e=r.getUniformLocation(this.program,t);return e}getProgram(){return this.program}}const qt=`
attribute vec3 aPosition;
attribute vec3 aColor;
attribute float aBrightness;

uniform mat4 uModel;
uniform mat4 uView;
uniform mat4 uProjection;

varying vec3 vColor;
varying float vBrightness;

void main() {
    vColor = aColor;
    vBrightness = aBrightness;
    gl_Position = uProjection * uView * uModel * vec4(aPosition, 1.0);
}
`,zt=`
precision mediump float;

varying vec3 vColor;
varying float vBrightness;

void main() {
    vec4 color = vec4(vColor, 1.0);
    gl_FragColor = vec4(color.rgb * vBrightness, color.a);
}
`,It=new ft(qt,zt);class at{constructor(t,e,s,i,o){this.min=F(),this.max=F(),this.collisionPoints=[],this.blocksCollidedInfo=[],this.min=this.oldMin=t,this.max=this.oldMax=e,this.width=s,this.depth=i,this.height=o}generateFeetToHeadCollisionPoints(){let t=this.width*2,e=this.depth*2,s=this.height,i=.5,o=.5,h=.5;this.width<.5&&(i=t),this.depth<.5&&(o=e),this.collisionPoints.push([[0,-.2,-.2],["z"]]),this.collisionPoints.push([[0,-.2,this.depth+.2],["z"]]),this.collisionPoints.push([[this.width+.2,-.2,0],["x"]]),this.collisionPoints.push([[-.2,-.2,0],["x"]]);for(let a=0;a<=t;a+=i)for(let c=0;c<=e;c+=o)for(let u=0;u<=s;u+=h)if(u+.1>s-.5&&(u=s-.1),a==0||a==t||c==0||c==e){let d=[];a>0&&c==0&&a!=t?d=["z"]:a==0&&c>0&&c!=e?d=["x"]:a>0&&c==e&&a!=t?d=["z"]:a==t&&c>0&&c!=e?d=["x"]:d=["x","z"],this.collisionPoints.push([[a*i,u+.1,c*o],d])}}generateCollisionPoints(){let t=this.width*2,e=this.depth*2,s=.5,i=.5;this.width<.5&&(s=t),this.depth<.5&&(i=e);for(let o=0;o<=t;o+=s)for(let h=0;h<=e;h+=i)this.collisionPoints.push([[o*s,-.2,h*i],["y"]]),this.collisionPoints.push([[o*s,1.9,h*i],["y"]]);this.generateFeetToHeadCollisionPoints()}checkAndResolveCollision(t){for(let e=0;e<this.blocksCollidedInfo.length;e++)this.blocksCollidedInfo[e].axis[0]==t&&(t=="y"?(this.min[1]=this.blocksCollidedInfo[e].auxMin[0][1],this.max[1]=this.blocksCollidedInfo[e].auxMax[0][1]):t=="x"?(this.min[0]=this.blocksCollidedInfo[e].auxMin[0][0],this.max[0]=this.blocksCollidedInfo[e].auxMax[0][0]):t=="z"&&(this.min[2]=this.blocksCollidedInfo[e].auxMin[0][2],this.max[2]=this.blocksCollidedInfo[e].auxMax[0][2]));this.blocksCollidedInfo=[]}getBlocksCollidedInfo(){for(let t=0;t<this.collisionPoints.length;t++)this.getBlocksCollidedInfoIfCollided(this.collisionPoints[t])}getBlocksCollidedInfoIfCollided(t){const s=l.getEntityByName("Player").getPhysics().collideWithBlocks(t),i=t[1];for(let o=0;o<i.length;o++)i[o]=="y"?this.blocksCollidedInfo.push(s):i[o]=="x"?this.blocksCollidedInfo.push(s):i[o]=="z"&&this.blocksCollidedInfo.push(s)}getPositionFromAABB(t){return t?[this.min[0]+t[0],this.min[1]+t[1],this.min[2]+t[2]]:[this.min[0]+this.width/2,this.min[1]+this.height,this.min[2]+this.depth/2]}updatePosition(t,e){this.oldMin=N(this.min),this.oldMax=N(this.max),e==="y"?this.max[1]-=t[1]:e==="x"?this.min[0]+=t[0]:e==="z"&&(this.min[2]+=t[2]),this.max[2]=this.min[2]+this.depth,this.max[0]=this.min[0]+this.width,this.min[1]=this.max[1]-this.height}intersects(t){return this.min[0]<t.max[0]&&this.max[0]>t.min[0]&&this.min[1]<t.max[1]&&this.max[1]>t.min[1]&&this.min[2]<t.max[2]&&this.max[2]>t.min[2]}collide(t,e){let s={auxMin:[],auxMax:[],axis:[]};if(!this.intersects(t))return s;for(let i=0;i<e.length;i++)e[i]=="y"&&(this.min[1]<=t.max[1]&&this.oldMin[1]>t.max[1]?s=this.setBottom(s,t.max[1]+.001):this.max[1]>=t.min[1]-.18&&this.oldMax[1]<t.min[1]&&(s=this.setTop(s,t.min[1]-.18-.001))),e[i]=="x"&&(this.max[0]>=t.min[0]&&this.oldMax[0]<t.min[0]?s=this.setRight(s,t.min[0]-.001):this.min[0]<=t.max[0]&&this.oldMin[0]>t.max[0]&&(s=this.setLeft(s,t.max[0]+.001))),e[i]=="z"&&(this.min[2]<=t.max[2]&&this.oldMin[2]>t.max[2]?s=this.setFront(s,t.max[2]+.001):this.max[2]>=t.min[2]&&this.oldMax[2]<t.min[2]&&(s=this.setBack(s,t.min[2]-.001)));return s}setTop(t,e){const i=l.getEntityByName("Player").getPhysics();i.setVelocity([i.getVelocity()[0],0,i.getVelocity()[2]]);const o=N(this.min),h=N(this.max);return o[1]=e-this.height,h[1]=e,t.axis.push("y"),t.auxMin.push(o),t.auxMax.push(h),t}setRight(t,e){const s=N(this.min),i=N(this.max);return s[0]=e-this.width,i[0]=e,t.axis.push("x"),t.auxMin.push(s),t.auxMax.push(i),t}setLeft(t,e){const s=N(this.min),i=N(this.max);return s[0]=e,i[0]=e+this.width,t.axis.push("x"),t.auxMin.push(s),t.auxMax.push(i),t}setBack(t,e){const s=N(this.min),i=N(this.max);return s[2]=e-this.depth,i[2]=e,t.axis.push("z"),t.auxMin.push(s),t.auxMax.push(i),t}setFront(t,e){const s=N(this.min),i=N(this.max);return s[2]=e,i[2]=e+this.depth,t.axis.push("z"),t.auxMin.push(s),t.auxMax.push(i),t}setBottom(t,e){const i=l.getEntityByName("Player").getPhysics();i.getIsOnGround(),i.setIsOnGround(!0),i.setVelocity([i.getVelocity()[0],0,i.getVelocity()[2]]);const o=N(this.min),h=N(this.max);return o[1]=e,h[1]=e+this.height,t.axis.push("y"),t.auxMin.push(o),t.auxMax.push(h),t}}var _=(n=>(n[n.TOOL=0]="TOOL",n[n.BLOCK=1]="BLOCK",n))(_||{});class Zt{constructor(){this.textureAtlas=new Image,this.blocksImage=new Image,this._meshesPooling=new Map,this._eraseToolbarFlag=!1,l.SCENENAME=="Level1"?(this.slot1={value:L.SHOVEL,source:0,quantity:1,htmlElement:document.getElementById("slot1")},this.slot2={value:g.AIR,source:1,quantity:0,htmlElement:document.getElementById("slot2")}):l.SCENENAME=="Level2"?(this.slot1={value:g.AIR,source:1,quantity:0,htmlElement:document.getElementById("slot1")},this.slot2={value:g.AIR,source:1,quantity:0,htmlElement:document.getElementById("slot2")}):l.SCENENAME=="Level3"?(this.slot1={value:g.AIR,source:1,quantity:0,htmlElement:document.getElementById("slot1")},this.slot2={value:g.AIR,source:1,quantity:0,htmlElement:document.getElementById("slot2")}):(this.slot1={value:g.AIR,source:1,quantity:0,htmlElement:document.getElementById("slot1")},this.slot2={value:g.AIR,source:1,quantity:0,htmlElement:document.getElementById("slot2")}),this.slots=[this.slot1,this.slot2],this._currentItem=this.slot1,this.createToolMeshOfAllSlots(),this._eraseToolbarFlag=!0}get eraseToolbarFlag(){return this._eraseToolbarFlag}set eraseToolbarFlag(t){this._eraseToolbarFlag=t}eraseToolbar(){this._eraseToolbarFlag&&(this._eraseToolbarFlag=!1,this.removeItem(2),this.removeItem(1))}getCurrentSlotPosition(){for(let t=0;t<this.slots.length;t++)if(this.slots[t]===this.currentItem)return t+1;return 0}removeCurrentItem(){this.currentItem.quantity--,this.setSlotImage(this.currentItem)}addItem(t,e,s,i,o){this._eraseToolbarFlag=!0;let h=!1;if(o){for(let a=0;a<this.slots.length;a++)if(this.slots[a]==this.currentItem&&this.slots[a].value==g.AIR){h=!0,this.slots[a].value=t,this.slots[a].source=e,s||i&&s?this.slots[a].quantity=s:this.slots[a].quantity=1,this.setSlotImage(this.slots[a]),!this.meshesPooling.has(t)&&e==0&&this.meshesPooling.set(t,this.createToolMesh(a+1)),this.slots[a]==this.currentItem&&this.highlightSlot(a+1);return}if(!h){for(let a=0;a<this.slots.length;a++)if(this.slots[a].value==g.AIR){this.slots[a].value=t,this.slots[a].source=e,s||i&&s?this.slots[a].quantity=s:this.slots[a].quantity=1,this.setSlotImage(this.slots[a]),!this.meshesPooling.has(t)&&e==0&&this.meshesPooling.set(t,this.createToolMesh(a+1)),this.slots[a]==this.currentItem&&this.highlightSlot(a+1);return}}}for(let a=0;a<this.slots.length;a++)if(this.slots[a].value==g.AIR&&!i||i&&this.slots[a]==this.currentItem){this.slots[a].value=t,this.slots[a].source=e,s||i&&s?this.slots[a].quantity=s:this.slots[a].quantity=1,this.setSlotImage(this.slots[a]),!this.meshesPooling.has(t)&&e==0&&this.meshesPooling.set(t,this.createToolMesh(a+1)),this.slots[a]==this.currentItem&&this.highlightSlot(a+1);return}else if(this.slots[a].value==t&&this.slots[a].source==e){this.slots[a].quantity++,this.setSlotImage(this.slots[a]);return}}removeItem(t){const e=this.slots[t-1];e.value=g.AIR,e.source=1,e.quantity=0,this.setSlotImage(e),this.highlightSlot(t)}createToolMesh(t){const s=[];for(let o=0;o<16;o++){s[o]=[];for(let h=0;h<16;h++){s[o][h]=[];for(let a=0;a<16;a++)s[o][h][a]=[null,null,null,null,null,null]}}const i=new bt(s,It,this.slots[t-1].value);return i.generateMeshData(),i}createToolMeshOfAllSlots(){for(let t=0;t<this.slots.length;t++)this.slots[t].source==0&&this.meshesPooling.set(this.slots[t].value,this.createToolMesh(t+1))}get meshesPooling(){return this._meshesPooling}set meshesPooling(t){this._meshesPooling=t}nextItem(){const e=(this.slots.indexOf(this._currentItem)+1)%this.slots.length;this.currentItem=this.slots[e],this.highlightSlot(e+1)}get currentItem(){return this._currentItem}set currentItem(t){this._currentItem=t}setSlotImage(t){const e=t.htmlElement,s=e.getElementsByClassName("quantity")[0];if(t.quantity>1?s.innerHTML=t.quantity.toString():t.quantity==1?s.innerHTML="":t.quantity==0&&(s.innerHTML="",t.value=g.AIR,t.source=1,l.getEntityByName("HandItemCube").mesh.removeBlock([0,0,0])),t.source==0)e.style.backgroundImage=`url('${this.textureAtlas.src}')`,e.style.backgroundSize="1700% 1600%",e.style.backgroundPosition=`${t.value%16*(100/15)}% ${Math.floor(t.value/16)*(100/15)}%`;else if(t.source==1){const i=t.value,o=Object.keys(g).length/2,h=i/(o-1)*100;e.style.backgroundImage=`url('${this.blocksImage.src}')`,e.style.backgroundSize=`${o*100}% 100%`,e.style.backgroundPosition=`${h}% 0%`}}async loadImages(){await this.loadImage(this.textureAtlas,"/img/textureAtlasTransparent.png"),await this.loadImage(this.blocksImage,"/img/blocksimage.png"),this.setSlotImage(this.slot1),this.setSlotImage(this.slot2)}loadImage(t,e){return new Promise((s,i)=>{t.onload=()=>s(),t.onerror=()=>i(new Error(`Erro ao carregar imagem: ${e}`)),t.src=e})}highlightSlot(t){l.getEntityByName("HandItemTool").stopBreaking();const s=this.slots[t-1],i=this.slot1.htmlElement,o=this.slot2.htmlElement;i.classList.remove("active"),o.classList.remove("active"),this.triggerSlot(s,t),s.htmlElement.classList.add("active")}triggerSlot(t,e){this._currentItem=t,t.source==1?(l.getEntityByName("HandItemTool").setVisible(!1),l.getEntityByName("HandItemCube").mesh.removeBlock([0,0,0]),l.getEntityByName("HandItemCube").mesh.addBlock([0,0,0],t.value),l.getEntityByName("HandItemCube").updateChunk(),l.getEntityByName("HandItemCube").setVisible(!0)):t.source==0&&(l.getEntityByName("HandItemTool").mesh=this.meshesPooling.get(t.value),l.getEntityByName("HandItemTool").setVisible(!0),l.getEntityByName("HandItemCube").setVisible(!1))}async init(){await this.loadImages()}}const Mt=class Mt{static loadSound(t,e){const s=new Audio(e);this.sounds.set(t,s),this.setVolume(t,.5)}static play(t){const e=this.sounds.get(t);e?(e.currentTime=0,e.play()):console.warn(`Sound "${t}" not found.`)}static stop(t){const e=this.sounds.get(t);e&&(e.pause(),e.currentTime=0)}static setVolume(t,e){const s=this.sounds.get(t);s&&(s.volume=Math.min(1,Math.max(0,e)))}static isLoaded(t){return this.sounds.has(t)}};Mt.sounds=new Map;let S=Mt;var L=(n=>(n[n.SHOVEL=16]="SHOVEL",n[n.PENCIL=17]="PENCIL",n[n.PICKAXE=18]="PICKAXE",n[n.GOLDENSHOVEL=19]="GOLDENSHOVEL",n[n.GOLDENPICKAXE=48]="GOLDENPICKAXE",n))(L||{});class D extends ht{constructor(t,e=16){const{nameId:s,handItem:i=!1,scale:o=[1,1,1],position:h=[0,0,0],tool:a=l.getEntityByName("Player").toolbar.currentItem.value,pickupItem:c=!1}=t,u=[];for(let m=0;m<e;m++){u[m]=[];for(let f=0;f<e;f++){u[m][f]=[];for(let y=0;y<e;y++)u[m][f][y]=[null,null,null,null,null,null]}}const d=new bt(u,It,a);super(s,d),this.tileSize=e,this.swayOffset=F(),this.swayStrength=.05,this.breakingSpeed=3,this.collected=!1,this.pickupItem=!1,this.tool=a,this.position=[-.001,0,-.1],this.handItem=i,this.scale=o,this.pickupItem=c,i?this.scale=[.004,.004,.004]:(this.rotate90=!0,this.position=h,d.generateMeshData(),l.getEntityByName("Player").toolbar.meshesPooling.set(a,d)),this.breakingTime=0,this.breakingDuration=1,this.isBreakingState=!1}startBreaking(){this.isBreakingState=!0,this.breakingTime=0}stopBreaking(){l.getEntityByName("Player").stopBreaking(),this.isBreakingState=!1}updateBreakingAnimation(t){this.isBreakingState&&(this.breakingTime+=t*this.breakingSpeed,this.breakingTime>=this.breakingDuration&&(this.breakingTime=0))}getBreakingPhase(){if(this.isBreakingState){const t=this.breakingTime/this.breakingDuration;return Math.sin(t*Math.PI*2)}else return 0}isBreaking(){return this.isBreakingState}updateWholeTool(){const t=[];for(let e=0;e<this.tileSize;e++){t[e]=[];for(let s=0;s<this.tileSize;s++){t[e][s]=[];for(let i=0;i<this.tileSize;i++)t[e][s][i]=[null,null,null,null,null,null]}}this.mesh=new bt(t,It,l.getEntityByName("Player").toolbar.currentItem.value),this.mesh.generateMeshData()}update(t,e){const s=l.getEntityByName("Player");if(!s.toolbar.eraseToolbarFlag&&this.pickupItem&&(this.visible=!0,this.collected=!1),!(!this.handItem&&this.collected))if(this.handItem){const i=l.getEntityByName("Player").getCamera(),o=i.getYaw(),a=-(o-(i.getLastYaw()??o))*this.swayStrength;this.swayOffset[0]+=(a-this.swayOffset[0])*.1,i.setLastYaw(o)}else{const i=[Math.floor(this.position[0]+.5),Math.floor(this.position[1]+.5),Math.floor(this.position[2]+.5)];let o=Math.floor(i[0]+.5);const h=Math.floor(i[1]+.5);let a=Math.floor(i[2]+.5);const c=Math.floor(o/16),u=Math.floor(a/16),d=l.getEntityByName(`Chunk[${c},${u}]`);if(d&&h>-1&&h<d.getChunkHeight()){const m=[o,h,a],f=new at([m[0]-.5,m[1]-.5,m[2]-.5],[m[0]+.5,m[1]-1,m[2]+.5],1,1,1);s.getPhysics().aabb.intersects(f)&&(S.play("collect"),this.collected=!0,s.toolbar.addItem(this.tool,_.TOOL,1,!1,!0),this.visible=!1)}}}getSwayOffset(){return this.swayOffset}}class ct{constructor(t){this.element=t,this.startCallbacks=[],this.moveCallbacks=[],this.endCallbacks=[],this.handleTouchStart=e=>{b.MENUON||e.preventDefault();for(let s of e.changedTouches)this.startCallbacks.forEach(i=>i(s))},this.handleTouchMove=e=>{for(let s of e.changedTouches)this.moveCallbacks.forEach(i=>i(s))},this.handleTouchEnd=e=>{for(let s of e.changedTouches)this.endCallbacks.forEach(i=>i(s))},this.element.addEventListener("touchstart",this.handleTouchStart,{passive:!1}),this.element.addEventListener("touchmove",this.handleTouchMove,{passive:!1}),this.element.addEventListener("touchend",this.handleTouchEnd,{passive:!1}),this.element.addEventListener("touchcancel",this.handleTouchEnd,{passive:!1})}onStart(t){this.startCallbacks.push(t)}onMove(t){this.moveCallbacks.push(t)}onEnd(t){this.endCallbacks.push(t)}destroy(){this.element.removeEventListener("touchstart",this.handleTouchStart),this.element.removeEventListener("touchmove",this.handleTouchMove),this.element.removeEventListener("touchend",this.handleTouchEnd),this.element.removeEventListener("touchcancel",this.handleTouchEnd)}}class Qt{constructor(){this.position=F(),this.front=K(0,0,-1),this.up=K(0,1,0),this.right=F(),this.yaw=-90,this.pitch=0,this.lastYaw=-90,this.lastPitch=0,this._sensitivity=.2,this.lastTouchX=0,this.lastTouchY=0,this.isTouching=!1,this.touchLookId=null,this._ignoreNextClick=!1,this._onMouseDown=e=>{const i=document.querySelector(".mobileButtonBackground").getBoundingClientRect();e.clientX>=i.left&&e.clientX<=i.right&&e.clientY>=i.top&&e.clientY<=i.bottom&&(this._ignoreNextClick=!0)},this._onMouseUp=e=>{const s=document.querySelector(".mobileButtonBackground"),i=document.querySelector("canvas"),o=s.getBoundingClientRect(),h=e.clientX>=o.left&&e.clientX<=o.right&&e.clientY>=o.top&&e.clientY<=o.bottom;if(this._ignoreNextClick||h){this._ignoreNextClick=!1;return}const a=document.getElementById("hud");a&&(a.style.opacity="1"),b.MENUON=!1,b.GAMEPAUSED=!1,b.PLAYERPAUSED=!1,i.requestPointerLock()},this._onMouseMove=e=>{if(b.PLAYERPAUSED)return;const s=e.movementX,i=e.movementY;this.yaw+=s*this.sensitivity,this.pitch-=i*this.sensitivity,this.pitch=Math.max(-89,Math.min(89,this.pitch)),this.updateVectors()},this.updateVectors(),this.initMouseLook(),this.initTouchLook(),P.addEventListener("mousemove",this._onMouseMove);const t=localStorage.getItem("fabrirama_sensitivity");if(t!==null){const e=parseFloat(t);this.sensitivity=e}else this.sensitivity=.2}set sensitivity(t){this._sensitivity=t;const e=document.getElementById("sensitivity");e&&(e.value=t.toString(),localStorage.setItem("fabrirama_sensitivity",t.toString()))}get sensitivity(){return this._sensitivity}destroy(){const t=document.querySelector("canvas"),e=document.querySelector("#hud");!t||!e||(e.removeEventListener("mousedown",this._onMouseDown),e.removeEventListener("mouseup",this._onMouseUp),t.removeEventListener("mousemove",this._onMouseMove))}getPitch(){return this.pitch}getYaw(){return this.yaw}updateVectors(){const t=this.yaw*(Math.PI/180),e=this.pitch*(Math.PI/180),s=Math.cos(t)*Math.cos(e),i=Math.sin(e),o=Math.sin(t)*Math.cos(e);this.front=nt(F(),K(s,i,o)),Vt(this.right,this.front,this.up),nt(this.right,this.right)}get ignoreNextClick(){return this._ignoreNextClick}set ignoreNextClick(t){this._ignoreNextClick=t}getViewMatrix(){const t=Bt(F(),this.position,this.front);return kt(J(),this.position,t,this.up)}getDirectionVectors(){return{front:this.front,right:this.right,up:this.up}}initMouseLook(){const t=document.querySelector("canvas"),e=document.querySelector("#hud"),s=document.querySelector(".mobileButtonBackground");!t||!e||!s||(this._ignoreNextClick=!1,e.addEventListener("mousedown",this._onMouseDown),e.addEventListener("mouseup",this._onMouseUp))}initTouchLook(){const t=document.getElementById("hud"),e=document.querySelector(".mobileButtonBackground");this._touchManager=new ct(t);const s=i=>{const o=e.getBoundingClientRect();return i.clientX>=o.left&&i.clientX<=o.right&&i.clientY>=o.top&&i.clientY<=o.bottom};this._touchManager.onStart(i=>{const o=document.elementFromPoint(i.clientX,i.clientY);o!=null&&o.closest("#hitButton, #jumpButton")||!s(i)&&this.touchLookId===null&&(this.isTouching=!0,this.touchLookId=i.identifier,this.lastTouchX=i.clientX,this.lastTouchY=i.clientY)}),this._touchManager.onMove(i=>{if(!this.isTouching||this.touchLookId!==i.identifier)return;const o=i.clientX-this.lastTouchX,h=i.clientY-this.lastTouchY;this.yaw+=o*this.sensitivity*3,this.pitch-=h*this.sensitivity*3,this.pitch=Math.max(-89,Math.min(89,this.pitch)),this.lastTouchX=i.clientX,this.lastTouchY=i.clientY,this.updateVectors()}),this._touchManager.onEnd(i=>{this.touchLookId===i.identifier&&(this.isTouching=!1,this.touchLookId=null)})}setPosition(t){Et(this.position,t)}getLastYaw(){return this.lastYaw}getLastPitch(){return this.lastPitch}setLastYaw(t){this.lastYaw=t}get touchManager(){return this._touchManager}set touchManager(t){this._touchManager=t}}class te{constructor(){this.origin={x:0,y:0},this.delta={x:0,y:0},this.isDragging=!1,this.touchId=null,this.handleSlot1Click=()=>this.handleSlotClick(1),this.handleSlot2Click=()=>this.handleSlotClick(2),this.handleHitDownBound=()=>this.handleHitDown(),this.handleHitUpBound=()=>this.handleHitUp(),this.handleJumpDown=()=>w.pressJumpButton(),this.handleJumpUp=()=>w.releaseJumpButton(),this.handleHitDown=()=>{const o=l.getEntityByName("Player");o.getCamera().ignoreNextClick=!0,o.toolbar.currentItem.source==_.BLOCK?w.pressRightClick():w.pressLeftClick()},this.handleHitUp=()=>{l.getEntityByName("Player").toolbar.currentItem.source==_.TOOL?w.releaseLeftClick():w.releaseRightClick()},this.handleSlotClick=o=>{const h=l.getEntityByName("Player");h.getCamera().ignoreNextClick=!0,h.toolbar.highlightSlot(o)},this.onTouchStart=o=>{this.touchId===null&&(this.touchId=o.identifier,this.startDragging(o.clientX,o.clientY))},this.onTouchMove=o=>{!this.isDragging||this.touchId!==o.identifier||this.moveStick(o.clientX,o.clientY)},this.onTouchEnd=o=>{this.touchId===o.identifier&&(this.touchId=null,this.onEnd())},this.onMouseDown=o=>{o.preventDefault(),this.startDragging(o.clientX,o.clientY)},this.onMouseMove=o=>{this.isDragging&&this.moveStick(o.clientX,o.clientY)},this.onMouseUp=()=>{this.isDragging&&this.onEnd()},this.onEnd=()=>{this.isDragging=!1,this.delta.x=0,this.delta.y=0,this.stick.style.transform="translate(-50%, -50%)"},this.stick=document.querySelector(".mobileButtonStick"),this.background=document.querySelector(".mobileButtonBackground"),this._touchManager=new ct(this.background),this._touchManager.onStart(this.onTouchStart),this._touchManager.onMove(this.onTouchMove),this._touchManager.onEnd(this.onTouchEnd),this.background.addEventListener("mousedown",this.onMouseDown),window.addEventListener("mousemove",this.onMouseMove),window.addEventListener("mouseup",this.onMouseUp);const t=document.getElementById("slot1"),e=document.getElementById("slot2"),s=document.getElementById("hitButton"),i=document.getElementById("jumpButton");t&&(t.addEventListener("mousedown",this.handleSlot1Click),t.addEventListener("touchstart",this.handleSlot1Click)),e&&(e.addEventListener("mousedown",this.handleSlot2Click),e.addEventListener("touchstart",this.handleSlot2Click)),s&&(this._touchManagerHitButton=new ct(s),this._touchManagerHitButton.onStart(this.handleHitDownBound),this._touchManagerHitButton.onEnd(this.handleHitUpBound),s.addEventListener("mousedown",this.handleHitDownBound),s.addEventListener("mouseup",this.handleHitUpBound)),i&&(this._touchManagerJumpButton=new ct(i),this._touchManagerJumpButton.onStart(this.handleJumpDown),this._touchManagerJumpButton.onEnd(this.handleJumpUp),i.addEventListener("mousedown",this.handleJumpDown),i.addEventListener("mouseup",this.handleJumpUp))}destroy(){this.onEnd(),this.touchManager.destroy(),this._touchManagerHitButton.destroy(),this._touchManagerJumpButton.destroy(),this.background.removeEventListener("mousedown",this.onMouseDown),window.removeEventListener("mousemove",this.onMouseMove),window.removeEventListener("mouseup",this.onMouseUp);const t=document.getElementById("slot1"),e=document.getElementById("slot2"),s=document.getElementById("hitButton"),i=document.getElementById("jumpButton");t&&(t.removeEventListener("mousedown",this.handleSlot1Click),t.removeEventListener("touchstart",this.handleSlot1Click)),e&&(e.removeEventListener("mousedown",this.handleSlot2Click),e.removeEventListener("touchstart",this.handleSlot2Click)),s&&(s.removeEventListener("mousedown",this.handleHitDownBound),s.removeEventListener("touchstart",this.handleHitDownBound),s.removeEventListener("mouseup",this.handleHitUpBound),s.removeEventListener("touchend",this.handleHitUpBound)),i&&(i.removeEventListener("mousedown",this.handleJumpDown),i.removeEventListener("touchstart",this.handleJumpDown),i.removeEventListener("mouseup",this.handleJumpUp),i.removeEventListener("touchend",this.handleJumpUp))}startDragging(t,e){const s=this.background.getBoundingClientRect();this.origin.x=t-s.left,this.origin.y=e-s.top,this.isDragging=!0}moveStick(t,e){const s=this.background.getBoundingClientRect(),i=t-s.left,o=e-s.top;this.delta.x=i-this.origin.x,this.delta.y=o-this.origin.y;const h=s.width/2,a=Math.hypot(this.delta.x,this.delta.y);if(a>h){const c=h/a;this.delta.x*=c,this.delta.y*=c}this.stick.style.transform=`translate(calc(-50% + ${this.delta.x}px), calc(-50% + ${this.delta.y}px))`}getDirection(){const e=this.background.getBoundingClientRect().width/2;return{x:this.delta.x/e,y:-this.delta.y/e}}isActive(){return this.isDragging}get touchManager(){return this._touchManager}set touchManager(t){this._touchManager=t}}class ee{constructor(t){this.gravity=-15.8,this.velocity=F(),this.isOnGround=!1;const e=.3,s=.3,i=1.7;this._aabb=new at(K(t[0]-e,t[1]-i,t[2]-s),K(t[0]+e,t[1],t[2]+s),e,s,i),this._aabb.generateCollisionPoints()}resetVelocity(){this.setVelocity([this.velocity[0],0,this.velocity[2]])}getIsOnGround(){return this.isOnGround}setIsOnGround(t){this.isOnGround=t}setVelocity(t){this.velocity=t}getVelocity(){return this.velocity}update(t,e){const i=l.getEntityByName("Player").getFlyMode();return this.velocity[0]=t[0],i&&(this.velocity[1]=t[1]),this.velocity[2]=t[2],i?(this._aabb.updatePosition(this.velocity,"y"),this._aabb.updatePosition(this.velocity,"x"),this._aabb.updatePosition(this.velocity,"z")):(this.velocity[1]-=this.gravity*(e/60),this._aabb.updatePosition(this.velocity,"y"),this._aabb.getBlocksCollidedInfo(),this._aabb.checkAndResolveCollision("y"),this._aabb.updatePosition(this.velocity,"x"),this._aabb.getBlocksCollidedInfo(),this._aabb.checkAndResolveCollision("x"),this._aabb.updatePosition(this.velocity,"z"),this._aabb.getBlocksCollidedInfo(),this._aabb.checkAndResolveCollision("z")),this._aabb.getPositionFromAABB()}jump(){this.isOnGround&&(l.getEntityByName("Player").playerOnTopOfGrassOrDirt,S.play("jump"),this.velocity[1]=-.1,this.isOnGround=!1)}collideWithBlocks(t){const e=this._aabb.getPositionFromAABB(t[0]);let s={auxMin:[],auxMax:[],axis:[]};const i=this.checkBlockSolid(e);if(i!==null){const[o,h]=i,a=new at([o[0]-.5,o[1]-.5,o[2]-.5],[o[0]+.5,o[1]+.5,o[2]+.5],1,1,1);if(s=this._aabb.collide(a,t[1]),h==g.REDCUBE&&s.axis[0]=="y")l.getEntityByName("Player").toolbar.eraseToolbar();else if((h==g.DIRT||h==g.GRASS||h==g.LEAVES)&&s.axis[0]=="y"){const c=l.getEntityByName("Player");c.playerOnTopOfGrassOrDirt=!0}else if(h!=g.DIRT&&h!=g.GRASS&&h!=g.LEAVES&&s.axis[0]=="y"){const c=l.getEntityByName("Player");c.playerOnTopOfGrassOrDirt=!1}}return s}checkBlockSolid(t){let e=Math.floor(t[0]+.5);const s=Math.floor(t[1]+.5);let i=Math.floor(t[2]+.5);const o=Math.floor(e/16),h=Math.floor(i/16);let a=(e%16+16)%16,c=(i%16+16)%16;const u=l.getEntityByName(`Chunk[${o},${h}]`);return u&&s>-1&&s<u.getChunkHeight()&&a>-1&&a<u.getChunkWidth()&&c>-1&&c<16&&u.getBlocks()[a][s][c]!==0?[[e,s,i],u.getBlocks()[a][s][c]]:null}get aabb(){return this._aabb}set aabb(t){this._aabb=t}}class At{constructor(t,e,s,i){this.colorBuffer=null,this.colors=[],this.drawLinesInsteadTriangles=!1,this.vertexBuffer=null,this.indexBuffer=null,this.vertices=t,this.indices=e,this.shader=s,this.colors=i,this.init()}init(){this.vertices.length&&(this.vertexBuffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.vertexBuffer),r.bufferData(r.ARRAY_BUFFER,new Float32Array(this.vertices),r.STATIC_DRAW),this.colorBuffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.colorBuffer),r.bufferData(r.ARRAY_BUFFER,new Float32Array(this.colors),r.STATIC_DRAW),this.indexBuffer=r.createBuffer(),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,this.indexBuffer),r.bufferData(r.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),r.STATIC_DRAW))}render(t){if(!this.vertexBuffer||!t.getVisible())return;this.shader.use();const e=t.getModel(),s=this.shader.getAttribLocation("aPosition"),i=this.shader.getUniformLocation("uModel");mt(e),V(e,e,t.position),rt(e,e,t.scale),r.uniformMatrix4fv(i,!1,e),r.bindBuffer(r.ARRAY_BUFFER,this.vertexBuffer),r.enableVertexAttribArray(s),r.vertexAttribPointer(s,this.shader.isPositionVec3?3:2,r.FLOAT,!1,0,0);const o=this.shader.getAttribLocation("aColor");r.bindBuffer(r.ARRAY_BUFFER,this.colorBuffer),r.enableVertexAttribArray(o),r.vertexAttribPointer(o,3,r.FLOAT,!1,0,0),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,this.indexBuffer),this.drawLinesInsteadTriangles?r.drawElements(r.LINES,this.indices.length,r.UNSIGNED_SHORT,0):r.drawElements(r.TRIANGLES,this.indices.length,r.UNSIGNED_SHORT,0)}getShader(){return this.shader}updateBuffers(){throw new Error("Method not implemented.")}}const se=`
attribute vec3 aPosition;
attribute vec3 aColor;
uniform mat4 uModel;
uniform mat4 uView;
uniform mat4 uProjection;
varying vec3 vColor;
void main() {
    vColor = aColor;
    gl_Position = uProjection * uView * uModel * vec4(aPosition, 1.0);
}
`,ie=`
precision mediump float;
varying vec3 vColor;
void main() {
    gl_FragColor = vec4(vColor, 0.3);
}
`,Ft=new ft(se,ie);class gt{constructor(){this.outputDiv=document.getElementById("consoleOutput"),this.outputDiv.style.display="none",this.input=document.createElement("input"),this.input.style.width="100%",this.input.style.maxWidth="100%",this.input.style.boxSizing="border-box",this.input.style.background="black",this.input.style.color="white",this.input.style.border="none",this.input.style.outline="none",this.input.style.fontSize="1em",this.input.style.padding="0.5em",this.input.style.display="none",this.outputDiv.appendChild(this.input),this.overrideConsole(),this.setupEventListeners()}overrideConsole(){const t=(e,s)=>{const i=document.createElement("div");i.style.marginBottom="0.3em",e==="error"?i.style.color="red":e==="warn"?i.style.color="orange":i.style.color="white",i.textContent=`[${e}] ${s.join(" ")}`,this.outputDiv.insertBefore(i,this.input),this.outputDiv.scrollTop=this.outputDiv.scrollHeight};["log","error","warn","info","debug"].forEach(e=>{const s=console[e];console[e]=(...i)=>{s.apply(console,i),t(e,i)}})}setupEventListeners(){window.addEventListener("keydown",t=>{if(t.key.toLowerCase()==="t"&&this.outputDiv.style.display==="none")b.PLAYERPAUSED=!0,this.outputDiv.style.display="block",this.input.style.display="block",this.input.focus(),t.preventDefault();else if(t.key==="Enter"&&this.outputDiv.style.display==="block"){b.PLAYERPAUSED=!1;const e=this.input.value.trim();e.length>0&&(console.log(`Executing: ${e}`),gt.executeCommand(e)),this.input.value="",this.outputDiv.style.display="none",this.input.style.display="none",t.preventDefault()}})}static executeCommand(t){const e=t.split(" ");if(e[0]==="fill"){const s=e[1];let i;const o=Number(s);if(!isNaN(o)&&g[o]!==void 0)i=o;else if(s in g)i=g[s];else throw new Error(`Invalid value for block id: ${s}`);l.getEntityByName("WireframeChunk").fillBasedLength(i)}else if(e[0]==="set"&&e[1]){const s=e[1].toUpperCase(),i=l.getEntityByName("Player");if(e[1]=="pencil")i.toolbar.removeItem(i.toolbar.getCurrentSlotPosition()),i.toolbar.addItem(L.PENCIL,_.TOOL);else if(e[1]=="shovel")i.toolbar.removeItem(i.toolbar.getCurrentSlotPosition()),i.toolbar.addItem(L.SHOVEL,_.TOOL);else if(s in g){const o=g[s];i.toolbar.removeItem(i.toolbar.getCurrentSlotPosition()),i.toolbar.addItem(o,_.BLOCK,50)}else console.warn(`Unknown item: "${s}"`)}else if(t=="creative"){localStorage.setItem("fabrirama_creative","true");const s=l.getEntityByName("Player");s.creativeMode=!s.creativeMode}else t==="hello"?console.log("Hello world!"):t==="time"?console.log(`Current time: ${new Date().toLocaleTimeString()}`):console.warn(`Unknown command: "${t}"`)}}class Y extends ht{constructor(t){const e=new At([-.5,-.5,.5,-.5,-.5,.5,.5,.5],[0,1,2,1,3,2],Ft,[1,0,0]);super("Player",e),this.speed=6,this.previousPosition=F(),this.currentPosition=F(),this.flyMode=!1,this.ctrlPressed=!1,this.previousOfCurrent=F(),this.breakStage=0,this.totalStages=6,this.interval=2e3/this.totalStages,this.breakingStartTime=0,this.breakingCubePosition=null,this.accumulatedTime=0,this.fixedStep=1/60,this._removeBlockImmediately=!1,this._creativeMode=!1,this._footstepTimer=0,this._footstepInterval=.35,this._hitGround=!1,this._firstTimeHitted=!1,this._playerOnTopOfGrassOrDirt=!1,this.camera=new Qt;const s=this.camera.position;Et(this.previousPosition,s),Et(this.currentPosition,s),this._joystick=new te,this.physics=new ee(t),this._toolbar=new Zt}get playerOnTopOfGrassOrDirt(){return this._playerOnTopOfGrassOrDirt}set playerOnTopOfGrassOrDirt(t){this._playerOnTopOfGrassOrDirt=t}get creativeMode(){return this._creativeMode}set creativeMode(t){this._creativeMode=t}async initToolbar(){this._toolbar.init()}getCamera(){return this.camera}updateBreaking(t){if(!this.breakingCubePosition)return;const e=t-this.breakingStartTime,s=Math.floor(e/this.interval);if(s>=this.totalStages){const[i,o,h]=this.breakingCubePosition,a=Math.floor(i/16),c=Math.floor(h/16),u=(i%16+16)%16,d=(h%16+16)%16,m=l.getEntityByName(`Chunk[${a},${c}]`),f=l.getEntityByName("BreakingCube"),y=m.getBlocks()[u][o][d];m.mesh.removeBlock([u,o,d]),f.setVisible(!1),this._toolbar.addItem(y,_.BLOCK),this.breakingCubePosition=null,S.play("place");return}if(s!==this.breakStage){this._toolbar.currentItem.value==L.PICKAXE||this._toolbar.currentItem.value==L.GOLDENPICKAXE?S.play("pickaxe"):S.play("dig");const i=l.getEntityByName("BreakingCube");i.mesh.removeBlock([0,0,0]),i.mesh.addBlock([0,0,0],g.BREAK1+s),this.breakStage=s}}startBreaking(t,e){if(this.breakingCubePosition||!(this._toolbar.currentItem.source==_.TOOL&&(this._toolbar.currentItem.value==L.SHOVEL||this._toolbar.currentItem.value==L.GOLDENSHOVEL||this._toolbar.currentItem.value==L.PICKAXE||this._toolbar.currentItem.value==L.GOLDENPICKAXE)))return;const s=Math.floor(t[0]+.5),i=Math.floor(t[1]+.5),o=Math.floor(t[2]+.5),h=Math.floor(s/16),a=Math.floor(o/16),c=(s%16+16)%16,u=(o%16+16)%16,d=l.getEntityByName(`Chunk[${h},${a}]`);if(!d||d.getBlocks()[c][i][u]!=g.DIRT&&this._toolbar.currentItem.value==L.SHOVEL||d.getBlocks()[c][i][u]!=g.GRASS&&d.getBlocks()[c][i][u]!=g.DIRT&&this._toolbar.currentItem.value==L.GOLDENSHOVEL||d.getBlocks()[c][i][u]!=g.STONE&&(this._toolbar.currentItem.value==L.PICKAXE||this._toolbar.currentItem.value==L.GOLDENPICKAXE))return;l.getEntityByName("BreakingCube").setVisible(!0),this.breakingStartTime=e,this.breakStage=-1,l.getEntityByName("HandItemTool").startBreaking(),this.breakingCubePosition=[s,i,o]}stopBreaking(){const t=l.getEntityByName("BreakingCube");this.breakStage=0,t.setVisible(!1),t.mesh.removeBlock([0,0,0]),this.breakingCubePosition=null}raycastForward(t,e=.1,s){const i=N(this.camera.position),o=this.camera.getDirectionVectors().front,h=N(o);nt(h,h);const a=N([i[0],i[1],i[2]]);this.previousOfCurrent=N(a);let c=0,u=!1;const d=l.getEntityByName("OutlineCube"),m=l.getEntityByName("BreakingCube");if(!d)return null;let f=!1;for(w.isKeyPressed("f")&&this._creativeMode&&(f=!0);c<t;){if(this.physics.checkBlockSolid(a)){d.setVisible(!0),u=!0,d.position=[Math.floor(a[0]+.5),Math.floor(a[1]+.5),Math.floor(a[2]+.5)],m.position=[Math.floor(a[0]+.5),Math.floor(a[1]+.5),Math.floor(a[2]+.5)],w.isMouseButtonPressed(0)&&this.breakingCubePosition==null?this.startBreaking(d.position,s):this.breakingCubePosition&&!Yt(this.breakingCubePosition,d.position)&&this.stopBreaking();break}this.previousOfCurrent=N(a),st(a,a,h,e),c+=e}return!u&&d&&(d.setVisible(!1),this.stopBreaking()),f&&(d.setVisible(!0),u=!0,d.position=[Math.floor(a[0]+.5),Math.floor(a[1]+.5),Math.floor(a[2]+.5)]),null}getPhysics(){return this.physics}getFlyMode(){return this.flyMode}addOrRemoveBlock(t,e){const s=[Math.floor(t[0]+.5),Math.floor(t[1]+.5),Math.floor(t[2]+.5)],i=l.getEntityByName("Chunk");let o=g.AIR;if(e){const h=s[1],a=s[0];if(!(h>-1&&h<i.getChunkHeight()&&a>-1&&a<i.getChunkWidth()))return;o=g.GRASS}i.getBlocks()[s[0]][s[1]][s[2]]=o,i.updateChunk()}drawChunkBetweenPoints(t,e){let s=e[0]-t[0]+1,i=e[1]-t[1]+1,o=e[2]-t[2]+1,h=F();s<1?(h[0]=e[0],s=t[0]-e[0]+1):h[0]=t[0],i<1?(h[1]=e[1],i=t[1]-e[1]+1):h[1]=t[1],o<1?(h[2]=e[2],o=t[2]-e[2]+1):h[2]=t[2];const a=new B({nameId:"WireframeChunk",chunkWidth:s,chunkHeight:i,chunkDepth:o,block:g.LEAVES,scale:[1,1,1],createMeshNow:!0,drawLinesInsteadTriangles:!0,fillAll:!0});a.position=h,l.addEntity(a)}async update(t,e){if(w.wasKeyJustPressed("h")&&localStorage.getItem("fabrirama_creative")=="true"&&(this.creativeMode=!this.creativeMode),w.wasKeyJustPressed("p")&&this.creativeMode&&gt.executeCommand("set pencil"),w.wasKeyJustPressed("r")&&this.creativeMode&&(this._removeBlockImmediately=!this._removeBlockImmediately),this.camera.position[1]<-10){l.initLoadingBar(),P.style.opacity="0";const c=document.getElementById("hud");c&&(c.style.opacity="0"),b.GAMEPAUSED=!0,await l.waitNextFrame(),b.switchToAnotherLevel("Level"+l.LEVELNUMBER,l.LEVELNUMBER)}this.updateBreaking(t),b.PLAYERPAUSED||(w.wasKeyJustPressed("1")?this._toolbar.highlightSlot(1):w.wasKeyJustPressed("2")&&this._toolbar.highlightSlot(2),w.wasKeyJustPressed("g")&&console.log(`${this.camera.position[0]}, ${this.camera.position[1]},
        ${this.camera.position[2]}`));const s=l.getEntityByName("HandItemTool");s.updateBreakingAnimation(e);const i=l.getEntityByName("OutlineCube");if(w.wasKeyJustPressed("b")&&this.creativeMode&&i.getVisible()){const c=i.position,u=Math.floor(c[0]+.5),d=Math.floor(c[1]+.5),m=Math.floor(c[2]+.5),f=Math.floor(u/16),y=Math.floor(m/16),E=(u%16+16)%16,p=(m%16+16)%16,A=l.getEntityByName(`Chunk[${f},${y}]`).getBlocks()[E][d][p];l.getEntityByName("Player").toolbar.addItem(A,_.BLOCK,99,!0)}if(w.wasMouseJustReleased(0)&&this._toolbar.currentItem.source==_.TOOL&&(this._toolbar.currentItem.value==L.SHOVEL||this._toolbar.currentItem.value==L.GOLDENSHOVEL||this._toolbar.currentItem.value==L.PICKAXE||this._toolbar.currentItem.value==L.GOLDENPICKAXE)&&(this.stopBreaking(),s.stopBreaking()),w.wasMouseJustPressed(0)){const c=i.position,u=Math.floor(c[0]+.5),d=Math.floor(c[1]+.5),m=Math.floor(c[2]+.5),f=Math.floor(u/16),y=Math.floor(m/16),E=(u%16+16)%16,p=(m%16+16)%16,I=l.getEntityByName(`Chunk[${f},${y}]`);if(I&&d>-1&&d<I.getChunkHeight()&&this._removeBlockImmediately&&i&&i.getVisible()&&I.mesh.removeBlock([E,d,p]),this._toolbar.currentItem.source==_.TOOL){if(this._toolbar.currentItem.value==L.SHOVEL||this._toolbar.currentItem.value==L.GOLDENSHOVEL||this._toolbar.currentItem.value==L.PICKAXE||this._toolbar.currentItem.value==L.GOLDENPICKAXE)s.startBreaking();else if(this._toolbar.currentItem.value==L.PENCIL&&i&&i.getVisible()){const A=l.getEntityByName("GreenCube");A.position=i.position;const R=l.getEntityByName("RedCube");this.drawChunkBetweenPoints(A.position,R.position)}}}if(i&&i.getVisible()){if(w.wasMouseJustPressed(2)&&this._toolbar.currentItem.source==_.BLOCK&&this._toolbar.currentItem.value!=g.AIR){const c=[Math.floor(this.previousOfCurrent[0]+.5),Math.floor(this.previousOfCurrent[1]+.5),Math.floor(this.previousOfCurrent[2]+.5)];let u=Math.floor(c[0]+.5);const d=Math.floor(c[1]+.5);let m=Math.floor(c[2]+.5);const f=Math.floor(u/16),y=Math.floor(m/16),E=l.getEntityByName(`Chunk[${f},${y}]`);if(E&&d>-1&&d<E.getChunkHeight()){const p=[u,d,m],I=new at([p[0]-.5,p[1]-.5,p[2]-.5],[p[0]+.5,p[1]+.5,p[2]+.5],1,1,1);this.physics.aabb.intersects(I)||(S.play("place"),E.mesh.addBlock(this.previousOfCurrent),this.toolbar.removeCurrentItem())}}if(w.wasMouseJustPressed(2)&&this._toolbar.currentItem.source==_.TOOL&&this._toolbar.currentItem.value==L.PENCIL){const c=l.getEntityByName("RedCube");c.position=i.position;const u=l.getEntityByName("GreenCube");this.drawChunkBetweenPoints(u.position,c.position)}}w.isKeyPressed("Control")&&this.creativeMode?this.ctrlPressed||(this.flyMode=!this.flyMode,this.ctrlPressed=!0):this.ctrlPressed=!1,this.raycastForward(2.5,.1,t),this.accumulatedTime+=Math.min(e,.1);let o=0;for(;this.accumulatedTime>=this.fixedStep&&o<5;)this.fixedUpdate(this.fixedStep),this.accumulatedTime-=this.fixedStep,o++;const h=this.accumulatedTime/this.fixedStep,a=Kt(F(),this.previousPosition,this.currentPosition,h);this.camera.setPosition(a),l.updateViewMatrix(this.camera.getViewMatrix())}fixedUpdate(t){const e=N(this.currentPosition),{front:s,right:i,up:o}=this.camera.getDirectionVectors(),h=K(s[0],0,s[2]);nt(h,h);const a=this.speed*t,c=F();let u=!1;if(this._joystick.isActive()){const f=this._joystick.getDirection();st(c,c,h,a*f.y),st(c,c,i,a*f.x),(f.x!==0||f.y!==0)&&(u=!0)}const d=F();b.PLAYERPAUSED||((w.isKeyPressed("w")||w.isKeyPressed("arrowup"))&&Bt(d,d,h),(w.isKeyPressed("s")||w.isKeyPressed("arrowdown"))&&Lt(d,d,h),(w.isKeyPressed("a")||w.isKeyPressed("arrowleft"))&&Lt(d,d,i),(w.isKeyPressed("d")||w.isKeyPressed("arrowright"))&&Bt(d,d,i),Ht(d)>0&&(u=!0,nt(d,d),st(c,c,d,a)),this.flyMode?(w.isKeyPressed(" ")&&(c[1]=-a,u=!0),w.isKeyPressed("Shift")&&(c[1]=a,u=!0)):(w.isKeyPressed(" ")&&this.physics.jump(),w.isKeyPressed("Shift")&&st(e,e,o,-a))),this.physics.getIsOnGround()&&this._hitGround?(this._hitGround=!1,this._firstTimeHitted?this.playerOnTopOfGrassOrDirt?S.play("footstepsOnGrass"):this.playerOnTopOfGrassOrDirt||S.play("footsteps"):this._firstTimeHitted=!0):!this.physics.getIsOnGround()&&!this._hitGround&&(this._hitGround=!0),u&&this.physics.getIsOnGround()?(this._footstepTimer+=t,this._footstepTimer>=this._footstepInterval&&(this.playerOnTopOfGrassOrDirt?S.play("footstepsOnGrass"):S.play("footsteps"),this._footstepTimer=0)):this._footstepTimer=0,this.previousPosition=N(this.currentPosition),this.physics.setIsOnGround(!1);const m=this.physics.update(c,t);this.currentPosition=N(m)}get joystick(){return this._joystick}set joystick(t){this._joystick=t}get toolbar(){return this._toolbar}set toolbar(t){this._toolbar=t}}class Ct extends ht{constructor(t,e){const s=[-.5,-.5,.5,.5,-.5,.5,-.5,.5,.5,.5,.5,.5,.5,-.5,-.5,-.5,-.5,-.5,.5,.5,-.5,-.5,.5,-.5,-.5,.5,.5,.5,.5,.5,-.5,.5,-.5,.5,.5,-.5,-.5,-.5,-.5,.5,-.5,-.5,-.5,-.5,.5,.5,-.5,.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,.5,.5,.5,-.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,.5],i=[0,1,2,1,3,2,4,5,6,5,7,6,8,9,10,9,11,10,12,13,14,13,15,14,16,17,18,17,19,18,20,21,22,21,23,22],o=[];for(let a=0;a<s.length/3;a++)o.push(e[0],e[1],e[2]);const h=new At(s,i,Ft,o);super(t,h),this.scale=[1.1,1.1,1.1]}update(t,e){var i,o;l.getEntityByName("Player").toolbar.currentItem.value==L.PENCIL?((i=l.getEntityByName("WireframeChunk"))==null||i.setVisible(!0),this.visible=!0):((o=l.getEntityByName("WireframeChunk"))==null||o.setVisible(!1),this.visible=!1)}}const ne=`
attribute vec3 aPosition;
attribute vec3 aColor;
uniform mat4 uModel;
uniform mat4 uView;
uniform mat4 uProjection;
varying vec3 vColor;
void main() {
    gl_Position = uProjection * uView * uModel * vec4(aPosition, 1.0);
    vColor = aColor;
}
`,oe=`
precision mediump float;
varying vec3 vColor;
void main() {
    gl_FragColor = vec4(vColor, 1.0);
}
`,re=new ft(ne,oe);class ae extends ht{constructor(t){const e=[[-.5,-.5,-.5],[.5,-.5,-.5],[.5,.5,-.5],[-.5,.5,-.5],[-.5,-.5,.5],[.5,-.5,.5],[.5,.5,.5],[-.5,.5,.5]],s=[4,5,6,4,6,7,1,0,3,1,3,2,0,4,7,0,7,3,5,1,2,5,2,6,3,7,6,3,6,2,0,1,5,0,5,4];function i([y,E,p],I,A){return[y*A[0]+I[0],E*A[1]+I[1],p*A[2]+I[2]]}const o=.005,h=1.005,a=[{position:[.5,.5,0],scale:[o,o,h]},{position:[-.5,.5,0],scale:[o,o,h]},{position:[0,.5,.5],scale:[h,o,o]},{position:[0,.5,-.5],scale:[h,o,o]},{position:[.5,0,.5],scale:[o,h,o]},{position:[.5,0,-.5],scale:[o,h,o]},{position:[-.5,0,-.5],scale:[o,h,o]},{position:[-.5,0,.5],scale:[o,h,o]},{position:[0,-.5,.5],scale:[h,o,o]},{position:[0,-.5,-.5],scale:[h,o,o]},{position:[.5,-.5,0],scale:[o,o,h]},{position:[-.5,-.5,0],scale:[o,o,h]}],c=[],u=[];let d=0;for(const{position:y,scale:E}of a){for(const p of e){const[I,A,R]=i(p,y,E);c.push(I,A,R)}for(const p of s)u.push(p+d);d+=8}const m=[];for(let y=0;y<c.length/3;y++)m.push(t[0],t[1],t[2]);const f=new At(c,u,re,m);super("OutlineCube",f),this.setVisible(!1)}}class X{constructor(){this.sceneId="SceneName"}init(t){this.start(t),this.run(),this.end()}start(t){w.initialize(),l.init(`Level${t}`,t),l.addEntity(new ae([0,0,0]))}end(){l.addEntity(new Ct("GreenCube",[0,1,0])),l.addEntity(new Ct("RedCube",[1,0,0])),l.startLoadingBlockData=!0,l.updateProjectionMatrix(),l.updateViewMatrix();const t=l.getEntityByName("Player");t.toolbar.init(),t.toolbar.highlightSlot(1)}}class he extends X{constructor(){super(...arguments),this.sceneId="Level1"}run(){l.addEntity(new Y([2.66,2.302,12.3])),l.addEntity(new D({nameId:"HandItemTool",handItem:!0},16)),l.addEntity(new B({nameId:"HandItemCube",chunkWidth:1,chunkHeight:1,chunkDepth:1,block:g.GRASS,handItem:!0,scale:[1,1,1],createMeshNow:!0})),l.addEntity(new B({nameId:"Chunk[0,0]",block:g.GRASS,loadFromJson:!0})),l.addEntity(new B({nameId:"Chunk[0,-1]",block:g.GRASS,loadFromJson:!0})),l.addEntity(new B({nameId:"BreakingCube",chunkWidth:1,chunkHeight:1,chunkDepth:1,block:g.BREAK1,scale:[1.001,1.001,1.001],createMeshNow:!0,visible:!1})),l.addEntity(new B({nameId:"Portal",chunkWidth:2,chunkHeight:2,chunkDepth:1,block:g.PORTAL1,scale:[1,1,1],createMeshNow:!0,visible:!0,fillAll:!0,position:[2,8,-1],animating:[g.PORTAL1,g.PORTAL2]}))}}class le extends X{constructor(){super(...arguments),this.sceneId="Level2"}run(){l.addEntity(new Y([7.59,12.21,7.71])),l.addEntity(new D({nameId:"HandItemTool",handItem:!0},16)),l.addEntity(new D({nameId:"ItemPickupPickaxe",handItem:!1,scale:[1/16,1/16,1/16],position:[-.5,10,-9],tool:L.PICKAXE,pickupItem:!0},16)),l.addEntity(new B({nameId:"HandItemCube",chunkWidth:1,chunkHeight:1,chunkDepth:1,block:g.GRASS,handItem:!0,scale:[1,1,1],createMeshNow:!0})),l.addEntity(new B({nameId:"Chunk[0,0]",block:g.GRASS,loadFromJson:!0})),l.addEntity(new B({nameId:"Chunk[0,-1]",block:g.GRASS,loadFromJson:!0})),l.addEntity(new B({nameId:"Chunk[0,-2]",block:g.GRASS,loadFromJson:!0,chunkHeight:20})),l.addEntity(new B({nameId:"Chunk[1,-2]",block:g.GRASS,loadFromJson:!0,chunkHeight:20})),l.addEntity(new B({nameId:"BreakingCube",chunkWidth:1,chunkHeight:1,chunkDepth:1,block:g.BREAK1,scale:[1.001,1.001,1.001],createMeshNow:!0,visible:!1})),l.addEntity(new B({nameId:"Portal",chunkWidth:2,chunkHeight:2,chunkDepth:1,block:g.PORTAL1,scale:[1,1,1],createMeshNow:!0,visible:!0,fillAll:!0,globalPosition:[26,16,-19],animating:[g.PORTAL1,g.PORTAL2]}))}}class ce extends X{constructor(){super(...arguments),this.sceneId="Level3"}run(){l.addEntity(new Y([7,3,9])),l.addEntity(new D({nameId:"HandItemTool",handItem:!0},16)),l.addEntity(new B({nameId:"HandItemCube",chunkWidth:1,chunkHeight:1,chunkDepth:1,block:g.GRASS,handItem:!0,scale:[1,1,1],createMeshNow:!0})),l.addEntity(new B({nameId:"Chunk[0,0]",block:g.GRASS,loadFromJson:!0})),l.addEntity(new B({nameId:"Chunk[-1,0]",block:g.GRASS,loadFromJson:!0})),l.addEntity(new B({nameId:"Chunk[-1,1]",block:g.GRASS,loadFromJson:!0})),l.addEntity(new D({nameId:"ItemPickupPickaxe",handItem:!1,scale:[1/16,1/16,1/16],position:[-.5+14,2,5],tool:L.PICKAXE,pickupItem:!0},16)),l.addEntity(new D({nameId:"ItemPickupShovel",handItem:!1,scale:[1/16,1/16,1/16],position:[-.5+-9,7,28],tool:L.SHOVEL,pickupItem:!0},16)),l.addEntity(new B({nameId:"BreakingCube",chunkWidth:1,chunkHeight:1,chunkDepth:1,block:g.BREAK1,scale:[1.001,1.001,1.001],createMeshNow:!0,visible:!1})),l.addEntity(new B({nameId:"Portal",chunkWidth:1,chunkHeight:2,chunkDepth:1,block:g.PORTAL1,scale:[1,1,1],createMeshNow:!0,visible:!0,fillAll:!0,globalPosition:[-2,6,31],animating:[g.PORTAL1,g.PORTAL2]}))}}class ue extends X{constructor(){super(...arguments),this.sceneId="Level4"}run(){l.addEntity(new Y([7,3,9])),l.addEntity(new D({nameId:"HandItemTool",handItem:!0},16)),l.addEntity(new B({nameId:"HandItemCube",chunkWidth:1,chunkHeight:1,chunkDepth:1,block:g.GRASS,handItem:!0,scale:[1,1,1],createMeshNow:!0})),l.addEntity(new B({nameId:"Chunk[0,0]",block:g.GRASS,loadFromJson:!0})),l.addEntity(new B({nameId:"Chunk[0,-1]",block:g.GRASS,loadFromJson:!0})),l.addEntity(new B({nameId:"Chunk[1,-1]",block:g.GRASS,loadFromJson:!0})),l.addEntity(new B({nameId:"Chunk[1,0]",block:g.GRASS,loadFromJson:!0})),l.addEntity(new B({nameId:"Chunk[-1,-1]",block:g.GRASS,loadFromJson:!0})),l.addEntity(new D({nameId:"ItemPickupPickaxe",handItem:!1,scale:[1/16,1/16,1/16],position:[-.5+25,2,-10],tool:L.PICKAXE,pickupItem:!0},16)),l.addEntity(new D({nameId:"ItemPickupShovel",handItem:!1,scale:[1/16,1/16,1/16],position:[-.5+7,2,14],tool:L.SHOVEL,pickupItem:!0},16)),l.addEntity(new B({nameId:"BreakingCube",chunkWidth:1,chunkHeight:1,chunkDepth:1,block:g.BREAK1,scale:[1.001,1.001,1.001],createMeshNow:!0,visible:!1})),l.addEntity(new B({nameId:"Portal",chunkWidth:2,chunkHeight:2,chunkDepth:1,block:g.PORTAL1,scale:[1,1,1],createMeshNow:!0,visible:!0,fillAll:!0,globalPosition:[-15,1,-1],animating:[g.PORTAL1,g.PORTAL2]}))}}class de extends X{constructor(){super(...arguments),this.sceneId="Level5"}run(){l.addEntity(new Y([7+.5+.25/2,3,7+.5+.25/2])),l.addEntity(new D({nameId:"HandItemTool",handItem:!0},16)),l.addEntity(new B({nameId:"HandItemCube",chunkWidth:1,chunkHeight:1,chunkDepth:1,block:g.GRASS,handItem:!0,scale:[1,1,1],createMeshNow:!0})),l.addEntity(new B({nameId:"Chunk[0,0]",block:g.LABBLOCK,loadFromJson:!0})),l.addEntity(new B({nameId:"Chunk[0,-1]",block:g.LABBLOCK,loadFromJson:!0})),l.addEntity(new B({nameId:"Chunk[1,-1]",block:g.LABBLOCK,loadFromJson:!0})),l.addEntity(new B({nameId:"Chunk[0,1]",block:g.LABBLOCK,loadFromJson:!0})),l.addEntity(new B({nameId:"Chunk[-1,0]",block:g.LABBLOCK,loadFromJson:!0})),l.addEntity(new B({nameId:"Chunk[-1,1]",block:g.LABBLOCK,loadFromJson:!0})),l.addEntity(new B({nameId:"Chunk[1,1]",block:g.LABBLOCK,loadFromJson:!0})),l.addEntity(new B({nameId:"Chunk[-1,-1]",block:g.LABBLOCK,loadFromJson:!0})),l.addEntity(new D({nameId:"ItemPickupPickaxe",handItem:!1,scale:[1/16,1/16,1/16],position:[-.5+18,2,-3],tool:L.PICKAXE,pickupItem:!0},16)),l.addEntity(new D({nameId:"ItemPickupShovel",handItem:!1,scale:[1/16,1/16,1/16],position:[-.5+28,2,24],tool:L.SHOVEL,pickupItem:!0},16)),l.addEntity(new B({nameId:"BreakingCube",chunkWidth:1,chunkHeight:1,chunkDepth:1,block:g.BREAK1,scale:[1.001,1.001,1.001],createMeshNow:!0,visible:!1})),l.addEntity(new B({nameId:"Portal",chunkWidth:2,chunkHeight:2,chunkDepth:1,block:g.PORTAL1,scale:[1,1,1],createMeshNow:!0,visible:!0,fillAll:!0,globalPosition:[-9,1,-16],animating:[g.PORTAL1,g.PORTAL2]}))}}class me extends X{constructor(){super(...arguments),this.sceneId="Level6"}run(){l.addEntity(new Y([7+.5+.25/2,3,7+.5+.25/2])),l.addEntity(new D({nameId:"HandItemTool",handItem:!0},16)),l.addEntity(new B({nameId:"HandItemCube",chunkWidth:1,chunkHeight:1,chunkDepth:1,block:g.GRASS,handItem:!0,scale:[1,1,1],createMeshNow:!0})),l.addEntity(new B({nameId:"Chunk[0,0]",block:g.LABBLOCK,loadFromJson:!0})),l.addEntity(new B({nameId:"Chunk[0,1]",block:g.LABBLOCK,loadFromJson:!0})),l.addEntity(new B({nameId:"Chunk[0,2]",block:g.LABBLOCK,loadFromJson:!0})),l.addEntity(new D({nameId:"ItemPickupGoldenShovel",handItem:!1,scale:[1/16,1/16,1/16],position:[7-.5+.25/2,2,7+.5+.25/2],tool:L.GOLDENSHOVEL,pickupItem:!0},16)),l.addEntity(new D({nameId:"ItemPickupGoldenShovel2",handItem:!1,scale:[1/16,1/16,1/16],position:[1-.5+.25/2,2,35+.5+.25/2],tool:L.GOLDENSHOVEL,pickupItem:!0},16)),l.addEntity(new B({nameId:"BreakingCube",chunkWidth:1,chunkHeight:1,chunkDepth:1,block:g.BREAK1,scale:[1.001,1.001,1.001],createMeshNow:!0,visible:!1})),l.addEntity(new B({nameId:"Portal",chunkWidth:2,chunkHeight:2,chunkDepth:1,block:g.PORTAL1,scale:[1,1,1],createMeshNow:!0,visible:!0,fillAll:!0,globalPosition:[6,1,40],animating:[g.PORTAL1,g.PORTAL2]}))}}class fe extends X{constructor(){super(...arguments),this.sceneId="Level7"}run(){l.addEntity(new Y([0+.5+.25/2,3,14+.5+.25/2])),l.addEntity(new D({nameId:"HandItemTool",handItem:!0},16)),l.addEntity(new B({nameId:"HandItemCube",chunkWidth:1,chunkHeight:1,chunkDepth:1,block:g.GRASS,handItem:!0,scale:[1,1,1],createMeshNow:!0})),l.addEntity(new B({nameId:"Chunk[0,0]",block:g.LABBLOCK,chunkHeight:32,loadFromJson:!0})),l.addEntity(new D({nameId:"ItemPickupPickaxe",handItem:!1,scale:[1/16,1/16,1/16],position:[-.5+6,16,7],tool:L.PICKAXE,pickupItem:!0},16)),l.addEntity(new B({nameId:"BreakingCube",chunkWidth:1,chunkHeight:1,chunkDepth:1,block:g.BREAK1,scale:[1.001,1.001,1.001],createMeshNow:!0,visible:!1})),l.addEntity(new B({nameId:"Portal",chunkWidth:1,chunkHeight:2,chunkDepth:1,block:g.PORTAL1,scale:[1,1,1],createMeshNow:!0,visible:!0,fillAll:!0,globalPosition:[7,29,15],animating:[g.PORTAL1,g.PORTAL2]}))}}class wt{init(t){this.start(t),this.run(),this.end()}start(t){l.init(`Level${t}`,t)}run(){l.addEntity(new B({nameId:"Chunk[0,0]",block:g.LABBLOCK,chunkHeight:32,loadFromJson:!0}))}end(){l.startLoadingBlockData=!0,l.updateProjectionMatrix()}}class j{static goToLevelSelection(){const t=document.getElementById("levelSelection"),e=document.getElementById("menu");t&&(t.style.display="flex",t.style.opacity="1"),e&&(e.style.display="none")}static async goToLevelSelectionMenu(){l.initLoadingBar(),b.GAMEPAUSED=!0,P.style.opacity="0";const t=document.getElementById("hud");t&&(t.style.opacity="0"),await l.waitNextFrame(),await l.waitNextFrame(),l.mainMenuScene=!0,b.MENUON=!1,b.destroyEventListeners();const e=new wt;if(!e)throw new Error("Scene not found!");l.clearEntities(),e.init(7);const s=document.getElementById("shadow");s&&(s.style.display="block"),j.goToLevelSelection()}static async restartLevel(){const t=l.getEntityByName("Player");t.getCamera().ignoreNextClick=!0,l.initLoadingBar(),P.style.opacity="0";const e=document.getElementById("hud");e&&(e.style.opacity="0"),b.GAMEPAUSED=!0,await l.waitNextFrame(),await l.waitNextFrame(),b.MENUON=!1,P.requestPointerLock(),b.switchToAnotherLevel("Level"+l.LEVELNUMBER,l.LEVELNUMBER)}static howToPlayButton(){const t=l.getEntityByName("Player");t.getCamera().ignoreNextClick=!0,j.howToPlayPage()}static howToPlayPage(){const t=document.getElementById("pauseMenu");t&&(t.style.display="none");const e=document.getElementById("howToPlayPage");e&&(e.style.display="flex");const s=document.getElementById("hud");s&&(s.style.opacity="0")}static pauseMenu(){const t=document.getElementsByClassName("anchor")[0];t&&(t.style.opacity="0");const e=l.getEntityByName("Player");e.getCamera().ignoreNextClick=!0;const s=!b.MENUON;b.PLAYERPAUSED=s,b.GAMEPAUSED=s,b.MENUON=s,s||P.requestPointerLock()}static goToMainMenu(){const t=document.getElementById("levelSelection"),e=document.getElementById("menu");t&&(t.style.display="none"),e&&(e.style.display="flex")}static init(){function t(){const f=l.getEntityByName("Player");f.getCamera().ignoreNextClick=!0}const e=document.getElementById("sensitivityMenu");e&&(e.onpointerdown=t,e.addEventListener("input",f=>{const y=f.target,E=l.getEntityByName("Player");E.getCamera().sensitivity=parseFloat(y.value)}));const s=document.getElementById("playButton");s&&(s.onclick=this.goToLevelSelection);const i=document.getElementById("levelSelectionButton");i&&(i.onpointerdown=this.goToLevelSelectionMenu);const o=document.getElementById("goToMainMenu");o&&(o.onclick=this.goToMainMenu);const h=document.getElementById("restartButton");h&&(h.onpointerdown=this.restartLevel);const a=document.getElementById("pauseButton");a&&(a.onpointerdown=this.pauseMenu);const c=document.getElementById("howToPlayButton");c&&(c.onpointerdown=this.howToPlayButton);const u=localStorage.getItem("fabrirama_lastlevel"),d=u?parseInt(u):1,m=document.getElementsByClassName("levelButton");for(let f=0;f<m.length;f++){const y=m[f],E=parseInt(y.innerHTML);E>d&&(y.setAttribute("disabled","true"),y.classList.add("disabled")),y.addEventListener("mousedown",async()=>{const p=document.getElementById("levelSelection"),I=document.getElementById("menu"),A=document.getElementById("shadow");p&&(p.style.display="none"),I&&(I.style.display="none"),A&&(A.style.display="none"),P.style.opacity="0",b.MENUON=!1,b.GAMEPAUSED=!0,b.PLAYERPAUSED=!0,l.mainMenuScene=!1,l.initLoadingBar();const R=document.getElementById("hud");R&&(R.style.opacity="0"),await l.waitNextFrame(),await l.waitNextFrame(),b.switchToAnotherLevel("Level"+E,E,!0)})}}}const Dt=[new he,new le,new ce,new ue,new de,new me,new fe],Rt=(n,t)=>{let e;return t?e=n+t:e=n,Dt.find(s=>s.sceneId===e)},ot=class ot{static set MENUON(t){if(t){const e=document.getElementById("pauseMenu");e&&(e.style.display="flex")}else{const e=document.getElementsByClassName("anchor")[0];e&&(e.style.opacity="1");const s=document.getElementById("pauseMenu");s&&(s.style.display="none");const i=document.getElementById("howToPlayPage");i&&(i.style.display="none")}this._MENUON=t}static get MENUON(){return this._MENUON}static destroyEventListeners(){const t=l.getEntityByName("Player");t.getCamera().destroy(),t.getCamera().touchManager.destroy(),t.joystick.destroy(),w.destroy()}static updateLevelButtonsState(){const t=localStorage.getItem("fabrirama_lastlevel"),e=t?parseInt(t):1,s=document.getElementsByClassName("levelButton");for(let i=0;i<s.length;i++){const o=s[i];parseInt(o.innerHTML)>e?(o.disabled=!0,o.classList.add("disabled")):(o.disabled=!1,o.classList.remove("disabled"))}}static async switchToAnotherLevel(t,e,s){P.style.opacity="0",this.GAMEPAUSED=!0,this.PLAYERPAUSED=!0,s||this.destroyEventListeners();let i,o=l.LEVELNUMBER,h="";if(e?o=e:o++,t?(i=Rt(t),h=t):(i=Rt("Level",o),h="Level"+o),Dt.length==o-1){l.mainMenuScene=!0;const u=document.getElementById("hud");u&&(u.style.opacity="0");const d=document.getElementById("shadow");d&&(d.style.display="block");const m=new wt;l.clearEntities(),m.init(7),j.goToMainMenu(),document.exitPointerLock();return}if(!i)throw new Error(`Scene ${h} not found!`);const a=localStorage.getItem("fabrirama_lastlevel");(a?parseInt(a):1)<o&&localStorage.setItem("fabrirama_lastlevel",String(o)),this.updateLevelButtonsState(),l.clearEntities(),i.init(o),await l.waitNextFrame(),await l.waitNextFrame()}};ot.GAMEPAUSED=!0,ot.PLAYERPAUSED=!0,ot._MENUON=!1;let b=ot;const x=class x{static initialize(){this.keyDownListener=s=>{x.keysPressed.add(s.key.toLowerCase())},window.addEventListener("keydown",this.keyDownListener),this.keyUpListener=s=>{x.keysPressed.delete(s.key.toLowerCase())},window.addEventListener("keyup",this.keyUpListener),this.mouseDownListener=s=>{if(document.pointerLockElement!==document.querySelector("#glCanvas"))return;const i=document.querySelector(".mobileButtonBackground");if(i){const o=i.getBoundingClientRect();if(s.clientX>=o.left&&s.clientX<=o.right&&s.clientY>=o.top&&s.clientY<=o.bottom)return}x.mouseButtonsPressed.add(s.button)},window.addEventListener("mousedown",this.mouseDownListener),this.mouseUpListener=s=>{if(document.pointerLockElement!==document.querySelector("#glCanvas"))return;const i=document.querySelector(".mobileButtonBackground");if(i){const o=i.getBoundingClientRect();if(s.clientX>=o.left&&s.clientX<=o.right&&s.clientY>=o.top&&s.clientY<=o.bottom)return}x.mouseButtonsPressed.delete(s.button)},window.addEventListener("mouseup",this.mouseUpListener);let t=0;const e=200;this.wheelListener=()=>{if(b.PLAYERPAUSED)return;const s=Date.now();s-t<e||(t=s,l.getEntityByName("Player").toolbar.nextItem())},window.addEventListener("wheel",this.wheelListener)}static destroy(){this.keysPressed=new Set,window.removeEventListener("keydown",this.keyDownListener),window.removeEventListener("keyup",this.keyUpListener),window.removeEventListener("mousedown",this.mouseDownListener),window.removeEventListener("mouseup",this.mouseUpListener),window.removeEventListener("wheel",this.wheelListener)}static wasKeyJustPressed(t){const e=t.toLowerCase(),s=x.keysPressed.has(e),i=x.previousKeysPressed.has(e);return s&&!i?(x.previousKeysPressed.add(e),!0):(!s&&i&&x.previousKeysPressed.delete(e),!1)}static wasMouseJustPressed(t){return this.mouseButtonsPressedThisFrame.has(t)}static wasMouseJustReleased(t){return this.mouseButtonsReleasedThisFrame.has(t)}static isKeyPressed(t){return x.keysPressed.has(t.toLowerCase())}static isMouseButtonPressed(t){return x.mouseButtonsPressed.has(t)}static update(){this.mouseButtonsPressedThisFrame.clear(),this.mouseButtonsReleasedThisFrame.clear();for(let t=0;t<=2;t++){const e=this.mouseButtonsPressed.has(t),s=this.previousMouseButtonsPressed.has(t);e&&!s&&this.mouseButtonsPressedThisFrame.add(t),!e&&s&&this.mouseButtonsReleasedThisFrame.add(t)}this.previousMouseButtonsPressed=new Set(this.mouseButtonsPressed)}static pressLeftClick(){x.mouseButtonsPressed.add(0)}static releaseLeftClick(){x.mouseButtonsPressed.delete(0)}static pressRightClick(){x.mouseButtonsPressed.add(2)}static releaseRightClick(){x.mouseButtonsPressed.delete(2)}static pressJumpButton(){const t=l.getEntityByName("Player");t.getCamera().ignoreNextClick=!0,x.keysPressed.add(" ")}static releaseJumpButton(){x.keysPressed.delete(" ")}};x.keysPressed=new Set,x.previousKeysPressed=new Set,x.mouseButtonsPressed=new Set,x.previousMouseButtonsPressed=new Set,x.mouseButtonsPressedThisFrame=new Set,x.mouseButtonsReleasedThisFrame=new Set;let w=x;const ge=`
attribute vec3 aPosition;
attribute vec2 aTexCoord;
attribute float aBrightness;

uniform mat4 uModel;
uniform mat4 uView;
uniform mat4 uProjection;

varying vec2 vTexCoord;
varying float vBrightness;

void main() {
    vTexCoord = aTexCoord;
    vBrightness = aBrightness;
    gl_Position = uProjection * uView * uModel * vec4(aPosition, 1.0);
}
`,ye=`
precision mediump float;

uniform sampler2D uTexture;
varying vec2 vTexCoord;
varying float vBrightness;

void main() {
    vec4 texColor = texture2D(uTexture, vTexCoord);
    gl_FragColor = vec4(texColor.rgb * vBrightness, texColor.a);
}
`,Pt=new ft(ge,ye);class B extends ht{constructor(t){const{nameId:e,chunkWidth:s=16,chunkHeight:i=16,chunkDepth:o=16,block:h=g.AIR,handItem:a=!1,scale:c=[1,1,1],drawLinesInsteadTriangles:u=!1,createMeshNow:d=!1,loadFromJson:m=!1,fillAll:f=!1,visible:y=!0,position:E=[0,0,0],animating:p=null,globalPosition:I=null}=t,A=[],R=[];let T=g.AIR;f&&(T=h);for(let v=0;v<s;v++){A[v]=[],R[v]=[];for(let k=0;k<i;k++){A[v][k]=[],R[v][k]=[];for(let U=0;U<o;U++)A[v][k][U]=T,R[v][k][U]=[null,null,null,null,null,null]}}for(let v=0;v<s;v++)for(let k=0;k<o;k++)A[v][0][k]=h;const C=new Tt(R,Pt,u);if(super(e,C),this.lastTime=0,this.frame=0,this.interval=400,this.mesh=C,this.mesh.chunk=this,this.blocks=A,this.chunkWidth=s,this.chunkHeight=i,this.chunkDepth=o,this.animating=p,a)this.scale=[.05,.05,.05],this.position=[.05,-.08,-.1],this.handItem=!0,this.rotate90=!1,this.visible=!1;else{if(this.scale=c,this.visible=y,E&&(this.position=E),e.includes("Chunk[")){const v=e.match(/\[(-?\d+),(-?\d+)\]/);if(v){const k=parseInt(v[1]),U=parseInt(v[2]);this.position[0]=k*s,this.position[2]=U*o,this.chunkHelper=this.addChunkHelper(k,U),this.chunkHelper.visible=!1}}I&&(this.position=I)}d&&C.generateMeshData(this),this._loadFromJson=m}addChunkHelper(t,e){const s=new B({nameId:`ChunkHelper[${t},${e}]`,chunkWidth:this.chunkWidth,chunkHeight:this.chunkHeight,chunkDepth:this.chunkDepth,block:g.LEAVES,scale:[1,1,1],createMeshNow:!0,drawLinesInsteadTriangles:!0,fillAll:!0});return s.position=this.position,l.addEntity(s),s}async init(){this.loadFromJson&&await this.loadBlocksFromFile(`chunks/${l.SCENENAME}/${this.nameId}.json`)}fillBasedLength(t){const e=Math.floor(this.position[0]),s=Math.floor(this.position[1]),i=Math.floor(this.position[2]),o=e+this.chunkWidth,h=s+this.chunkHeight,a=i+this.chunkDepth;for(let c=e;c<o;c++)for(let u=s;u<h;u++)for(let d=i;d<a;d++){let m=c,f=d;const y=Math.floor(m/16),E=Math.floor(f/16),p=l.getEntityByName(`Chunk[${y},${E}]`);p&&u>-1&&u<p.getChunkHeight()&&p.mesh.addBlock([m,u,f],t,!0)}}async update(t,e){if(this.animating){if(t-this.lastTime>=this.interval){this.frame=1-this.frame,this.lastTime=t;for(let f=0;f<this.chunkWidth;f++)this.mesh.removeBlock([f,0,0]),this.mesh.removeBlock([f,1,0]),this.mesh.addBlock([f,0,0],this.animating[this.frame]),this.mesh.addBlock([f,1,0],this.animating[this.frame])}const i=l.getEntityByName("Player"),o=[Math.floor(this.position[0]+.5),Math.floor(this.position[1]+.5),Math.floor(this.position[2]+.5)];let h=Math.floor(o[0]+.5);const a=Math.floor(o[1]+.5);let c=Math.floor(o[2]+.5);const u=Math.floor(h/16),d=Math.floor(c/16),m=l.getEntityByName(`Chunk[${u},${d}]`);if(m&&a>-1&&a<m.getChunkHeight()){const f=[h,a,c],y=new at([f[0]-.5,f[1]-.5,f[2]-.5],[f[0]+this.chunkWidth-.5,f[1]+.5,f[2]+.5],1,1,1);if(i.getPhysics().aabb.intersects(y)&&!b.GAMEPAUSED){l.initLoadingBar(),P.style.opacity="0";const E=document.getElementById("hud");E&&(E.style.opacity="0"),b.GAMEPAUSED=!0,await l.waitNextFrame(),b.switchToAnotherLevel();return}}}if(b.PLAYERPAUSED)return;const s=l.getEntityByName("Player");if(w.wasKeyJustPressed("c")){const i=l.getEntityByName("Player"),o=[Math.floor(i.getCamera().position[0]+.5),Math.floor(i.getCamera().position[1]+.5),Math.floor(i.getCamera().position[2]+.5)];let h=Math.floor(o[0]+.5),a=Math.floor(o[2]+.5);const c=Math.floor(h/16),u=Math.floor(a/16),d=l.getEntityByName(`Chunk[${c},${u}]`);d&&this.copyBlocksToClipboard(d)}else this.nameId=="Chunk[0,0]"&&w.wasKeyJustPressed("v")&&s.creativeMode&&this.loadBlocksFromFile("/public/chunks/TestChunk.json");if(w.wasKeyJustPressed("q")&&s.creativeMode){for(const d of l.getEntities().values())d.getNameId().includes("ChunkHelper[")&&d.setVisible(!d.getVisible());const i=[Math.floor(s.getCamera().position[0]+.5),Math.floor(s.getCamera().position[1]+.5),Math.floor(s.getCamera().position[2]+.5)];let o=Math.floor(i[0]+.5),h=Math.floor(i[2]+.5);const a=Math.floor(o/16),c=Math.floor(h/16);l.getEntityByName(`Chunk[${a},${c}]`)&&console.log(a,c)}}copyBlocksToClipboard(t){const e=JSON.stringify(t.getBlocks());navigator.clipboard.writeText(e).then(()=>console.log("Blocks copied to clipboard")).catch(s=>console.error("Failed to copy blocks:",s))}async loadBlocksFromFile(t){try{const e=await fetch(t);if(!e.ok)throw new Error("Failed to load file: "+t);const s=await e.json();this.loadBlocksFromJSON(s)}catch(e){console.error("Error loading JSON file:",e)}}loadBlocksFromJSON(t){this.blocks=t}updateChunk(){this.mesh.updateBuffers()}updateWholeChunk(){const t=[];for(let e=0;e<this.chunkWidth;e++){t[e]=[];for(let s=0;s<this.chunkHeight;s++){t[e][s]=[];for(let i=0;i<this.chunkDepth;i++)t[e][s][i]=[null,null,null,null,null,null]}}this.mesh=new Tt(t,Pt),this.mesh.generateMeshData(this)}getBlocks(){return this.blocks}getChunkWidth(){return this.chunkWidth}getChunkHeight(){return this.chunkHeight}getChunkDepth(){return this.chunkDepth}get loadFromJson(){return this._loadFromJson}set loadFromJson(t){this._loadFromJson=t}}const M=class M{static set mainMenuScene(t){this._mainMenuScene=t}static get mainMenuScene(){return this._mainMenuScene}static createMeshOfChunks(){for(const[t,e]of this.entities.entries())t.match(/Chunk\[(-?\d+),(-?\d+)\]/)&&e instanceof B&&e.mesh.generateMeshData(e)}static initLoadingBar(){M.chunksLoaded=0,M.LOADINGPERCENT=0,this.chunksToLoadNumber=0,this.startLoadingBlockData=!1,this.startLoadingMeshData=!1,this.chunksLoadedMesh=0,this.updateChunksLoadedDescription(" ")}static init(t,e,s=!1){this.SCENENAME=t,this.LEVELNUMBER=e,this.initLoadingBar(),r.enable(r.DEPTH_TEST),r.enable(r.CULL_FACE),r.cullFace(r.BACK),r.frontFace(r.CCW),r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA)}static clearEntities(){M.entities.clear()}static removeEntityByName(t){return M.entities.delete(t)}static getEntityByName(t){return M.entities.get(t)}static updateChunksLoadedDescription(t){const e=document.getElementById("chunksLoaded");e&&(e.innerHTML=t);const s=this.texturesToLoad+this.chunksToLoadNumber*2,i=this.texturesLoaded+this.chunksLoaded+this.chunksLoadedMesh;M.LOADINGPERCENT=Math.floor(i/s*100),t==" "&&(M.LOADINGPERCENT=0);const o=document.getElementById("loadingPercent");o&&(o.innerHTML=M.LOADINGPERCENT.toString()+"%");const h=document.getElementsByClassName("loading-bar")[0];h&&(h.style.width=M.LOADINGPERCENT.toString()+"%")}static async addEntity(t){M.entities.set(t.getNameId(),t),t.getNameId().match(/Chunk\[(-?\d+),(-?\d+)\]/)&&t instanceof B&&this.chunksToLoad.push(t)}static async loadBlocksData(){const t=/\[(-?\d+),(-?\d+)\]/;for(const[e,s]of this.entities)t.test(e)&&await s.init()}static updateViewMatrix(t){t?M.uView=t:kt(M.uView,[3,3,3],[0,0,0],[0,1,0]);for(const e of this.entities.values()){const s=e.mesh.getShader();s.use();const i=s.getUniformLocation("uView");r.uniformMatrix4fv(i,!1,M.uView)}}static updateViewMatrixAndOrbit(t,e){if(e)M.uView=e;else{const s=[8,10,8],i=15,o=10,h=.2;this.orbitAngle+=t*h;const a=s[0]+i*Math.cos(this.orbitAngle),c=s[2]+i*Math.sin(this.orbitAngle),u=[a,o,c];kt(M.uView,u,s,[0,1,0])}for(const s of this.entities.values()){const i=s.mesh.getShader();i.use();const o=i.getUniformLocation("uView");r.uniformMatrix4fv(o,!1,M.uView)}}static updateProjectionMatrix(){const e=Math.PI/180*90,s=P.width/P.height;Ut(M.uProjection,e,s,.01,100);for(const h of this.entities.values()){const a=h.mesh.getShader();a.use();const c=a.getUniformLocation("uProjection");c!=-1&&r.uniformMatrix4fv(c,!1,M.uProjection)}}static getEntities(){return M.entities}static waitNextFrame(){return new Promise(t=>requestAnimationFrame(()=>t()))}static async update(t,e){if(M.updateViewMatrixAndOrbit(e),this.startLoadingBlockData&&this.chunksToLoadNumber==0&&(this.chunksToLoadNumber=this.chunksToLoad.length),this.chunksToLoad.length>0&&this.startLoadingBlockData){const s=this.chunksToLoad.shift();s&&(this.updateChunksLoadedDescription(`Chunks ${this.chunksLoaded}/${this.chunksToLoadNumber}`),await s.init(),this.chunksToLoadMesh.push(s),this.chunksLoaded++,this.updateChunksLoadedDescription(`Chunks ${this.chunksLoaded}/${this.chunksToLoadNumber}`))}if(this.chunksToLoadMesh.length>0&&(this.chunksToLoadNumber==this.chunksToLoadMesh.length||this.startLoadingMeshData)&&this.startLoadingBlockData){this.startLoadingMeshData=!0;const s=this.chunksToLoadMesh.shift();s&&(this.updateChunksLoadedDescription(`Terrain ${this.chunksLoadedMesh}/${this.chunksToLoadNumber}`),s.mesh.generateMeshData(s),this.chunksLoadedMesh++,this.updateChunksLoadedDescription(`Terrain ${this.chunksLoadedMesh}/${this.chunksToLoadNumber}`))}if(!b.MENUON&&b.GAMEPAUSED&&this.chunksToLoadMesh.length==0&&this.chunksLoaded!=0){if(this.mainMenuScene){const s=document.getElementById("shadow");s&&(s.style.opacity="0.3");const i=document.getElementById("menu");i&&(i.style.opacity="1")}else if(M.LEVELNUMBER==1&&!localStorage.getItem("fabrirama_howtoplay"))j.howToPlayPage(),localStorage.setItem("fabrirama_howtoplay","viewed");else{const s=document.getElementById("hud");s&&(s.style.opacity="1"),P.requestPointerLock()}this.mainMenuScene?P.style.opacity="1":setTimeout(()=>{P.style.opacity="1"},50),b.GAMEPAUSED=!1,b.PLAYERPAUSED=!1}if(!b.GAMEPAUSED||b.MENUON){for(const s of this.entities.values())s.update(t,e);w.update()}}static render(){for(const t of this.entities.values())t.mesh.render(t)}};M.entities=new Map,M.uView=J(),M.uProjection=J(),M.LEVELNUMBER=1,M.LOADINGPERCENT=0,M.chunksToLoad=[],M.chunksLoaded=0,M.chunksLoadedMesh=0,M.chunksToLoadMesh=[],M.startLoadingBlockData=!1,M.startLoadingMeshData=!1,M.chunksToLoadNumber=0,M.texturesToLoad=1,M.texturesLoaded=0,M.orbitAngle=0,M._mainMenuScene=!0;let l=M;class pe{constructor(){if(this.lastTime=performance.now(),this.resizeCanvas=()=>{const t=window.devicePixelRatio||1;P.width=window.innerWidth*t,P.height=window.innerHeight*t,P.style.width=window.innerWidth+"px",P.style.height=window.innerHeight+"px",r.viewport(0,0,P.width,P.height),l.updateProjectionMatrix()},this.renderLoop=async t=>{const e=performance.now(),s=(e-this.lastTime)/1e3;this.lastTime=e,(!b.GAMEPAUSED||b.MENUON)&&(r.clearColor(.6,.8,1,1),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT)),await l.update(t,s),(!b.GAMEPAUSED||b.MENUON)&&l.render(),requestAnimationFrame(this.renderLoop)},!r)console.error("Error to initialize WebGL");else{const t=window.devicePixelRatio||1;P.width=window.innerWidth*t,P.height=window.innerHeight*t,P.style.width=window.innerWidth+"px",P.style.height=window.innerHeight+"px",r.viewport(0,0,P.width,P.height),r.clear(r.COLOR_BUFFER_BIT)}window.addEventListener("resize",this.resizeCanvas)}startRendering(){requestAnimationFrame(this.renderLoop)}}new gt;j.init();S.loadSound("footstepsOnGrass","/sounds/footsteps-on-grass.mp3");S.loadSound("footsteps","/sounds/footsteps.wav");S.loadSound("jump","/sounds/jump.wav");S.setVolume("jump",.3);S.loadSound("dig","/sounds/dig.ogg");S.loadSound("pickaxe","/sounds/pickaxe.ogg");S.setVolume("pickaxe",.2);S.loadSound("collect","/sounds/collect.wav");S.setVolume("collect",.3);S.loadSound("place","/sounds/place.wav");S.setVolume("place",.6);async function ke(){b.GAMEPAUSED=!0,b.PLAYERPAUSED=!0,P.style.opacity="0",l.updateChunksLoadedDescription("Textures 0/1"),new pe().startRendering(),await $t("/img/textureAtlasTransparent.png"),l.texturesLoaded=1,l.updateChunksLoadedDescription("Textures 1/1");const t=new wt;if(!t)throw new Error("Scene not found!");t.init(7)}ke().catch(console.error);
